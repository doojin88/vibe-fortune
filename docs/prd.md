# Product Requirement Document (PRD)

## 1. 제품 개요

### 1.1 프로젝트명
**Vibe Fortune** - AI 기반 사주분석 서비스

### 1.2 제품 설명
Gemini API를 활용하여 전문적인 사주팔자 분석을 제공하는 웹 서비스입니다. 사용자는 Google 계정으로 간편하게 로그인하고, 생년월일과 출생시간을 입력하여 AI가 생성한 맞춤형 사주분석 결과를 받을 수 있습니다. 과거 분석 이력을 저장하고 언제든지 다시 확인할 수 있습니다. 무료 사용자는 최초 3회 분석 가능하며, Pro 구독을 통해 월 10회 고급 분석을 이용할 수 있습니다.

### 1.3 핵심 가치 제안
- **간편한 접근성**: Google 계정으로 1분 안에 시작 가능
- **AI 기반 전문성**: Gemini API를 활용한 20년 경력 사주상담사 수준의 분석
- **이력 관리**: 과거 사주분석 결과를 언제든 재확인
- **유연한 구독 모델**: 무료 체험 후 필요시 Pro 구독으로 업그레이드
- **실시간 스트리밍**: AI 분석 결과를 실시간으로 확인

### 1.4 기술 스택
- **프론트엔드**: Next.js 15 (App Router), React, TypeScript, TailwindCSS
- **인증**: Clerk (Google OAuth)
- **데이터베이스**: Supabase (PostgreSQL)
- **AI 엔진**: Google Gemini API (gemini-2.5-flash, gemini-2.5-pro)
- **결제**: 토스페이먼츠 (자동결제/빌링)
- **배포**: Vercel

---

## 2. Stakeholders

### 2.1 내부 이해관계자
- **제품 책임자 (Product Owner)**: 제품 비전 및 우선순위 결정
- **개발자**: 기술 구현 및 유지보수
- **디자이너**: UI/UX 설계

### 2.2 외부 이해관계자
- **최종 사용자**: 사주분석 서비스 이용자
  - 자기 이해에 관심 있는 20-40대
  - 사주/운세에 관심 있는 일반인
  - 전통 문화에 관심 있는 사용자
- **서비스 제공자**
  - Clerk (인증 서비스)
  - Supabase (데이터베이스)
  - Google Gemini (AI API)
  - 토스페이먼츠 (결제 서비스)

---

## 3. 포함 페이지

### 3.1 페이지 목록 및 접근 권한

| 페이지명 | 경로 | 접근 권한 | 설명 |
|---------|------|----------|------|
| 홈 (랜딩 페이지) | `/` | 누구나 | 서비스 소개 및 주요 기능 안내 |
| 대시보드 | `/dashboard` | 로그인 필요 | 사주분석 이력 목록 조회 |
| 새 검사하기 | `/dashboard/new` | 로그인 필요 | 새로운 사주분석 요청 |
| 사주분석 상세 | `/dashboard/results/[id]` | 로그인 필요 (본인만) | 사주분석 결과 상세 조회 |
| 구독 관리 | `/subscription` | 로그인 필요 | 구독 정보 확인 및 관리 |

### 3.2 공용 레이아웃

홈 이외의 모든 페이지는 다음 공용 레이아웃을 가집니다:

**Header**:
- 서비스명 (클릭 시 대시보드 페이지로 이동)
- 메뉴: 대시보드, 구독관리
- 프로필 아바타 및 드롭다운 메뉴 (Clerk UserButton)

**Sidebar**:
- 메뉴: '대시보드', '새 검사'
- 하단에 구독 상태 표시:
  - 이메일
  - 잔여 검사 횟수
  - 요금제 (무료/Pro)
  - 다음 결제일 (Pro 구독자만)

### 3.3 페이지별 상세 명세

#### 3.3.1 홈 (`/`)
**목적**: 서비스 소개 및 사용자 유입

**접근 권한**: 누구나

**화면 구성**:
- **헤더**
  - 로고 (좌측)
  - 앵커 메뉴: 홈, 서비스, 가격, FAQ
  - 사용자 메뉴 (우측)
    - 비로그인: "시작하기" 버튼
    - 로그인: "이용하기" 버튼

- **Hero 섹션**
  - 메인 헤드라인
  - 서브 헤드라인
  - CTA 버튼 ("시작하기" / "이용하기")
  - 이미지

- **Features 섹션**
  - AI 기반 전문 분석
  - 간편한 Google 로그인
  - 분석 이력 관리

- **Pricing 섹션**
  - 무료 요금제: 초기 3회 분석 (gemini-2.5-flash 사용)
  - Pro 요금제: 월 10회 분석 (gemini-2.5-pro 사용)
  - 가격 정보 및 혜택 비교

- **FAQ 섹션**
  - 자주 묻는 질문 및 답변

- **Footer**

**사용자 인터랙션**:
- "시작하기" / "이용하기" 버튼 클릭 → `/dashboard`로 이동
- 비로그인 상태에서 대시보드 접근 시 → Clerk 로그인 페이지로 리다이렉트

---

#### 3.3.2 대시보드 (`/dashboard`)
**목적**: 사주분석 이력 관리 및 새 분석 시작

**접근 권한**: 로그인 필요

**화면 구성**:
- **공용 헤더 및 사이드바**

- **메인 컨텐츠**
  - 페이지 제목: "내 사주분석 이력"
  - 페이지 설명
  - 검색바 (검사자 이름으로 검색 가능)
  - "새 검사하기" 버튼 (우측 상단)
  - 사주분석 이력 목록 (3 column grid card)
    - 각 카드 포함 정보:
      - 분석 대상 이름
      - 생년월일
      - 성별
      - 분석 날짜
      - 미리보기 (첫 100자)
    - 빈 상태: "아직 사주분석 이력이 없습니다" 메시지 + "첫 검사 시작하기" 버튼

**사용자 인터랙션**:
- "새 검사하기" 버튼 클릭 → `/dashboard/new`로 이동
- 이력 카드 클릭 → `/dashboard/results/[id]`로 이동
- 검색바에 이름 입력 → 실시간 필터링
- 최신 순으로 정렬 (분석 날짜 기준)

**데이터 요구사항**:
- Supabase에서 현재 사용자의 사주분석 이력 조회
- 페이지네이션 또는 무한 스크롤 (이력 10개 이상 시)

---

#### 3.3.3 새 검사하기 (`/dashboard/new`)
**목적**: 새로운 사주분석 요청

**접근 권한**: 로그인 필요

**화면 구성**:
- **공용 헤더 및 사이드바**

- **메인 컨텐츠**
  - 페이지 제목: "새 사주분석"
  - 페이지 설명
  - 입력 폼
    - **성함** (필수)
      - 타입: 텍스트 입력
      - 검증: 1-50자
      - 에러 메시지: "성함을 입력해주세요"

    - **생년월일** (필수)
      - 타입: Date Picker 또는 텍스트 입력
      - 포맷: YYYY-MM-DD
      - 검증: 유효한 날짜, 1900-01-01 ~ 현재
      - 에러 메시지: "올바른 생년월일을 입력해주세요"

    - **출생시간** (선택)
      - 타입: Time Picker 또는 텍스트 입력
      - 포맷: HH:mm
      - 체크박스: "출생시간 모름"
      - 체크 시 시간 입력 비활성화

    - **성별** (필수)
      - 타입: 라디오 버튼
      - 옵션: 남성 / 여성
      - 에러 메시지: "성별을 선택해주세요"

  - "검사 시작" 버튼
    - 필수 항목 미입력 시 비활성화
    - 활성화 조건: 성함, 생년월일, 성별 모두 입력

**검사 플로우**:
1. 사용자가 '새 검사' 페이지에 진입한다.
2. 사용자가 검사 정보를 입력하고 '검사시작' 버튼을 클릭한다.
3. 서버에서 해당 사용자의 잔여 검사 횟수를 확인한다.
   - 잔여 검사 횟수가 0인 경우, 사용자에게 구독 페이지로 이동하라는 메시지를 표시한다.
   - 잔여 검사 횟수가 1회 이상인 경우, 다음 단계로 진행한다.
4. 서버에서 Gemini API를 호출하여 사주 분석을 수행한다.
   - 무료 사용자: gemini-2.5-flash 모델 사용
   - Pro 구독자: gemini-2.5-pro 모델 사용
5. 분석이 진행되는 동안 dialog를 표시하고, 완성중인 결과를 실시간으로 streaming하여 보여준다.
6. 분석이 완료되면 제출된 검사정보와 함께 데이터베이스에 저장하고, 완료되었음을 사용자에게 alert로 알린다.
7. 사용자가 alert의 확인 버튼을 누르면, 사용자를 분석 상세보기 페이지로 리다이렉트한다.

**에러 처리**:
- 잔여 검사 횟수 부족 → "검사 횟수가 부족합니다. 구독 페이지로 이동하시겠습니까?" 다이얼로그 표시
- API 호출 실패 → 에러 토스트 메시지 표시
- 네트워크 에러 → "다시 시도해주세요" 메시지
- 폼 검증 실패 → 해당 필드 아래 에러 메시지

**성능 요구사항**:
- AI 분석 응답 시간: 10-30초 예상
- 타임아웃: 60초

---

#### 3.3.4 사주분석 상세 (`/dashboard/results/[id]`)
**목적**: 사주분석 결과 조회

**접근 권한**: 로그인 필요 (본인 분석만 접근 가능)

**화면 구성**:
- **공용 헤더 및 사이드바**

- **메인 컨텐츠**
  - 페이지 제목
  - 페이지 설명

  - **입력된 검사 정보 카드**
    - 이름
    - 생년월일
    - 출생시간 (있을 경우)
    - 성별
    - 분석 날짜

  - **사주분석 결과**
    - 마크다운 렌더링
    - 포함 섹션:
      1. 천간(天干)과 지지(地支)
      2. 오행(五行) 분석
      3. 대운(大運)과 세운(歲運)
      4. 성격 분석
      5. 재운 분석
      6. 건강운 분석
      7. 연애운 분석

  - **액션 버튼**
    - "목록으로" 버튼 (좌측)
    - "새 검사하기" 버튼 (우측)
    - "결과 복사" 버튼 (상단 우측)

**사용자 인터랙션**:
- "목록으로" 버튼 클릭 → `/dashboard`로 이동
- "새 검사하기" 버튼 클릭 → `/dashboard/new`로 이동
- "결과 복사" 버튼 클릭 → 클립보드에 마크다운 텍스트 복사, 토스트 메시지 표시

**보안 요구사항**:
- 본인 사주분석만 조회 가능
- 다른 사용자 분석 접근 시 → 404 페이지 또는 대시보드로 리다이렉트

**데이터 요구사항**:
- Supabase에서 해당 ID의 사주분석 조회
- 사용자 ID 일치 여부 검증

---

#### 3.3.5 구독 관리 (`/subscription`)
**목적**: 구독 정보 확인 및 구독 관리

**접근 권한**: 로그인 필요

**화면 구성**:
- **공용 헤더 및 사이드바**

- **메인 컨텐츠**
  - 페이지 제목: "구독 관리"
  - 페이지 설명

  - **현재 구독 상태 표시**
    - 이메일 주소
    - 현재 요금제 (무료/Pro)
    - 잔여 검사 횟수
    - 다음 결제일 (Pro 구독자의 경우)
    - 구독 시작일
    - 카드 정보 (Pro 구독자의 경우, 마지막 4자리만 표시)

  - **구독 상태에 따른 액션 버튼**
    - **무료 사용자**: "Pro 구독하기" 버튼
    - **Pro 구독자 (활성)**: "구독 취소" 버튼
    - **Pro 구독자 (취소 예약)**: "구독 재개" 버튼

**사용자 인터랙션**:

**무료 사용자 → Pro 구독**:
1. "Pro 구독하기" 버튼 클릭
2. 토스페이먼츠 결제창 표시 (SDK 사용)
3. 카드 정보 입력 및 본인인증
4. 빌링키 발급 및 저장
5. 첫 결제 진행 (월 9,900원)
6. 구독 완료 → 구독 관리 페이지로 리다이렉트
7. 월 10회 검사 횟수 추가
8. 다음 결제일 설정 (30일 후)

**Pro 구독자 → 구독 취소**:
1. "구독 취소" 버튼 클릭
2. 취소 확인 다이얼로그 표시
   - "구독을 취소하시겠습니까?"
   - "다음 결제일까지 Pro 혜택이 유지됩니다."
3. 확인 버튼 클릭
4. 구독 상태를 '취소 예약'으로 변경
5. 다음 결제일까지 Pro 혜택 유지
6. 다음 결제일 전까지 "구독 재개" 가능

**Pro 구독자 (취소 예약) → 구독 재개**:
1. "구독 재개" 버튼 클릭
2. 구독 재개 확인 다이얼로그 표시
3. 확인 버튼 클릭
4. 구독 상태를 '활성'으로 변경
5. 다음 결제일에 자동 결제 재개

**구독 해지 (다음 결제일 도달 시)**:
1. Supabase Cron Job이 매일 오전 2시에 실행
2. 다음 결제일이 지난 '취소 예약' 구독 조회
3. 해당 구독의 빌링키 삭제 (토스페이먼츠 API 호출)
4. 구독 상태를 '해지'로 변경
5. 사용자는 무료 요금제로 전환 (월 0회, 추가 구독 필요)

**데이터 요구사항**:
- Supabase에서 현재 사용자의 구독 정보 조회
- 토스페이먼츠 API를 통한 결제 및 빌링키 관리

---

## 4. 사용자 여정 (User Journey)

### 4.1 타겟 유저 Segment

#### Segment 1: 신규 사용자 (미가입)
**특징**:
- 사주분석 서비스를 처음 이용
- Google 계정 보유
- 자기 이해 또는 운세에 관심

**여정**:
```
1. 홈페이지 방문 (/)
   ↓
2. Hero 섹션에서 서비스 소개 확인
   ↓
3. Pricing 섹션에서 무료 3회 체험 확인
   ↓
4. "시작하기" 버튼 클릭
   ↓
5. Clerk 로그인 페이지로 리다이렉트
   ↓
6. Google 계정으로 로그인
   ↓
7. 대시보드로 이동 (/dashboard)
   ↓
8. 빈 상태 확인: "첫 검사 시작하기" 버튼 클릭
   ↓
9. 새 검사하기 페이지 (/dashboard/new)
   ↓
10. 정보 입력 (이름, 생년월일, 출생시간, 성별)
   ↓
11. "검사 시작" 버튼 클릭
   ↓
12. 로딩 다이얼로그 표시 (실시간 스트리밍으로 분석 결과 확인)
   ↓
13. 분석 완료 alert → 확인 버튼 클릭
   ↓
14. 사주분석 상세 페이지로 자동 이동 (/dashboard/results/[id])
   ↓
15. 분석 결과 확인 (마크다운 렌더링)
   ↓
16. 잔여 횟수 확인: 2회 남음 (사이드바에 표시)
```

---

#### Segment 2: 무료 사용자 (3회 소진)
**특징**:
- 이미 3회 분석 완료
- Pro 구독 고려 중

**여정**:
```
1. 대시보드 접근 (/dashboard)
   ↓
2. 사이드바에서 잔여 횟수 0회 확인
   ↓
3. "새 검사하기" 버튼 클릭 → 잔여 횟수 부족 다이얼로그 표시
   ↓
4. "구독 페이지로 이동" 버튼 클릭
   ↓
5. 구독 관리 페이지 (/subscription)
   ↓
6. Pro 요금제 혜택 확인 (월 10회, 고급 모델 사용)
   ↓
7. "Pro 구독하기" 버튼 클릭
   ↓
8. 토스페이먼츠 결제창 표시
   ↓
9. 카드 정보 입력 및 본인인증
   ↓
10. 결제 완료 → 구독 관리 페이지로 리다이렉트
   ↓
11. Pro 구독 상태 확인 (월 10회, 다음 결제일 표시)
   ↓
12. 새 검사하기 페이지로 이동 (/dashboard/new)
   ↓
13. 사주분석 진행 (gemini-2.5-pro 모델 사용)
```

---

#### Segment 3: Pro 구독자 (재방문)
**특징**:
- Pro 요금제 구독 중
- 정기적으로 사주분석 이용

**여정 A: 과거 결과 재확인**
```
1. 홈페이지 방문 (/) 또는 직접 /dashboard 접근
   ↓
2. 이미 로그인 상태 → 대시보드 (/dashboard)
   ↓
3. 사이드바에서 Pro 구독 상태 확인 (잔여 8회, 다음 결제일)
   ↓
4. 사주분석 이력 목록 확인
   ↓
5. 검색바에 이름 입력하여 특정 분석 찾기
   ↓
6. 특정 이력 카드 클릭
   ↓
7. 사주분석 상세 페이지 (/dashboard/results/[id])
   ↓
8. 분석 결과 재확인
   ↓
9. "결과 복사" 버튼 클릭 → 클립보드에 복사
```

**여정 B: 새 분석 요청**
```
1. 대시보드 (/dashboard)
   ↓
2. "새 검사하기" 버튼 클릭
   ↓
3. 새 검사하기 페이지 (/dashboard/new)
   ↓
4. 정보 입력
   ↓
5. "검사 시작" 버튼 클릭
   ↓
6. 로딩 다이얼로그 (실시간 스트리밍)
   ↓
7. 분석 완료 alert → 확인
   ↓
8. 사주분석 상세 페이지 (/dashboard/results/[id])
   ↓
9. 고급 분석 결과 확인 (gemini-2.5-pro)
   ↓
10. "목록으로" 버튼 클릭 → 대시보드에서 새 이력 확인
```

---

#### Segment 4: Pro 구독자 (구독 취소 고려)
**특징**:
- Pro 구독 중이지만 이용 빈도 낮음
- 구독 취소 고려

**여정**:
```
1. 헤더 메뉴에서 "구독관리" 클릭
   ↓
2. 구독 관리 페이지 (/subscription)
   ↓
3. 현재 구독 정보 확인 (Pro, 잔여 7회, 다음 결제일 2025-02-15)
   ↓
4. "구독 취소" 버튼 클릭
   ↓
5. 취소 확인 다이얼로그 표시
   - "구독을 취소하시겠습니까?"
   - "다음 결제일(2025-02-15)까지 Pro 혜택이 유지됩니다."
   ↓
6. "확인" 버튼 클릭
   ↓
7. 구독 상태 변경: Pro (취소 예약)
   ↓
8. 페이지 새로고침 → "구독 재개" 버튼 표시
   ↓
9. 다음 결제일까지 Pro 혜택 유지 (월 10회, gemini-2.5-pro)
   ↓
10. (선택) "구독 재개" 버튼 클릭 → 구독 상태를 '활성'으로 복구
```

---

## 5. Information Architecture (IA)

### 5.1 사이트 구조 (Tree 시각화)

```
Vibe Fortune
│
├── / (홈 - 누구나 접근 가능)
│   ├── Hero Section
│   ├── Features Section
│   ├── Pricing Section
│   │   ├── 무료 요금제 (초기 3회, gemini-2.5-flash)
│   │   └── Pro 요금제 (월 10회, gemini-2.5-pro, 월 9,900원)
│   ├── FAQ Section
│   └── Footer
│
├── /sign-in (로그인 - Clerk 제공)
│   └── Google OAuth
│
├── /sign-up (회원가입 - Clerk 제공)
│   └── Google OAuth
│
├── /dashboard (대시보드 - 인증 필요)
│   │
│   ├── 사주분석 이력 목록
│   │   ├── 검색바 (검사자 이름으로 검색)
│   │   ├── 이력 카드 1 → /dashboard/results/[id-1]
│   │   ├── 이력 카드 2 → /dashboard/results/[id-2]
│   │   └── ...
│   │
│   ├── /dashboard/new (새 검사하기 - 인증 필요)
│   │   └── 사주분석 입력 폼
│   │       ├── 성함 입력
│   │       ├── 생년월일 입력
│   │       ├── 출생시간 입력 (선택, "모름" 체크박스)
│   │       ├── 성별 선택
│   │       └── 검사 시작
│   │           ├── 잔여 횟수 확인
│   │           ├── Gemini API 호출 (무료: flash, Pro: pro)
│   │           ├── 실시간 스트리밍
│   │           └── 완료 → /dashboard/results/[new-id]
│   │
│   └── /dashboard/results/[id] (사주분석 상세 - 인증 필요, 본인만)
│       ├── 입력된 검사 정보
│       ├── 사주분석 결과 (마크다운)
│       │   ├── 천간과 지지
│       │   ├── 오행 분석
│       │   ├── 대운과 세운
│       │   ├── 성격 분석
│       │   ├── 재운 분석
│       │   ├── 건강운 분석
│       │   └── 연애운 분석
│       ├── 목록으로 → /dashboard
│       ├── 새 검사하기 → /dashboard/new
│       └── 결과 복사
│
└── /subscription (구독 관리 - 인증 필요)
    │
    ├── 현재 구독 정보
    │   ├── 이메일
    │   ├── 요금제 (무료/Pro)
    │   ├── 잔여 검사 횟수
    │   ├── 다음 결제일 (Pro만)
    │   └── 카드 정보 (Pro만, 마지막 4자리)
    │
    └── 구독 액션
        ├── 무료 사용자: "Pro 구독하기" → 토스페이먼츠 결제창
        ├── Pro 구독자 (활성): "구독 취소" → 취소 예약
        └── Pro 구독자 (취소 예약): "구독 재개" → 활성 복구
```

### 5.2 네비게이션 구조

#### 5.2.1 글로벌 네비게이션
- **홈페이지 헤더**
  - 로고 (→ `/`)
  - 홈 (→ `/#hero`)
  - 서비스 (→ `/#features`)
  - 가격 (→ `/#pricing`)
  - FAQ (→ `/#faq`)
  - 시작하기 / 이용하기 (→ `/dashboard`)

- **대시보드 헤더**
  - 로고 (→ `/dashboard`)
  - 대시보드 (→ `/dashboard`)
  - 구독관리 (→ `/subscription`)
  - UserButton (Clerk 제공)

- **사이드바**
  - 대시보드 (→ `/dashboard`)
  - 새 검사 (→ `/dashboard/new`)
  - 구독 상태 표시 (하단)
    - 이메일
    - 잔여 검사 횟수
    - 요금제
    - 다음 결제일

#### 5.2.2 사용자 액션 플로우
```
[홈]
  → 시작하기/이용하기
    → [로그인] (비로그인 시)
      → [대시보드]
        ├── 이력 카드 클릭 → [사주분석 상세]
        │                      ├── 목록으로 → [대시보드]
        │                      └── 새 검사하기 → [새 검사하기]
        │
        ├── 새 검사하기 → [새 검사하기]
        │                  ├── 잔여 횟수 부족 → [구독 관리]
        │                  └── 검사 시작 → [사주분석 상세]
        │
        └── 사이드바 구독 상태 → [구독 관리]
                                  ├── Pro 구독하기 → 토스페이먼츠 결제
                                  ├── 구독 취소 → 취소 예약
                                  └── 구독 재개 → 활성 복구
```

---

## 6. 기능 요구사항

### 6.1 인증 (Clerk)

#### 6.1.1 로그인/회원가입
- **방식**: Google OAuth (Clerk 제공)
- **필수 정보**: 이메일, 이름
- **로그인 상태 관리**: Clerk SDK 자동 처리
- **세션 유지**: 브라우저 세션 기반

#### 6.1.2 권한 관리
- **비로그인 사용자**: 홈페이지만 접근 가능
- **로그인 사용자**: 모든 페이지 접근 가능
- **본인 데이터만 조회**: 사주분석 결과는 본인만 접근

#### 6.1.3 Clerk Webhook 연동
- **목적**: Clerk 사용자 정보를 Supabase에 동기화
- **이벤트**: `user.created`, `user.updated`
- **동작**:
  - 신규 사용자 생성 시 → Supabase `users` 테이블에 레코드 생성
  - 사용자 정보 업데이트 시 → Supabase `users` 테이블 업데이트
  - 신규 사용자는 무료 요금제로 시작 (초기 3회 제공)
- **배포 필요**: Webhook은 배포된 환경에서만 작동

---

### 6.2 AI 사주분석 (Gemini API)

#### 6.2.1 분석 프로세스
1. 사용자 입력 데이터 수집 (이름, 생년월일, 출생시간, 성별)
2. 잔여 검사 횟수 확인
3. 구독 상태에 따른 모델 선택
   - 무료 사용자: gemini-2.5-flash
   - Pro 구독자: gemini-2.5-pro
4. 시스템 프롬프트 생성
5. Gemini API 호출 (실시간 스트리밍)
6. 응답 파싱 (마크다운 형식)
7. Supabase에 분석 결과 저장
8. 잔여 검사 횟수 차감
9. 사용자에게 결과 페이지 표시

#### 6.2.2 시스템 프롬프트 구조
```typescript
export const generateSajuPrompt = (input: TestInput, isPro: boolean): string => {
  const basePrompt = `당신은 ${isPro ? '30년 경력의 전문' : '20년 경력의'} 사주팔자 상담사입니다.

**입력 정보**:
- 성함: ${input.name}
- 생년월일: ${input.birthDate}
- 출생시간: ${input.birthTime || '미상'}
- 성별: ${input.gender === 'male' ? '남성' : '여성'}

**분석 요구사항**:
1️⃣ 천간(天干)과 지지(地支) 계산
2️⃣ 오행(五行) 분석 (목, 화, 토, 금, 수)
3️⃣ 대운(大運)과 세운(歲運) 해석
4️⃣ 전반적인 성격, 재운, 건강운, 연애운 분석
${isPro ? '5️⃣ 직업운, 사업운, 투자 조언\n6️⃣ 월별 운세 및 길일 분석' : ''}

**출력 형식**: 마크다운 (제목, 목록, 강조 활용)

**금지 사항**:
- 의료·법률 조언
- 확정적 미래 예측
- 부정적·공격적 표현`;

  return basePrompt;
};
```

#### 6.2.3 분석 결과 구조
- **형식**: 마크다운
- **포함 섹션**:
  1. 천간과 지지
  2. 오행 분석
  3. 대운과 세운
  4. 성격 분석
  5. 재운 분석
  6. 건강운 분석
  7. 연애운 분석
  8. (Pro 전용) 직업운 및 사업운
  9. (Pro 전용) 월별 운세

#### 6.2.4 성능 및 에러 처리
- **응답 시간**:
  - gemini-2.5-flash: 10-20초 예상
  - gemini-2.5-pro: 20-40초 예상
- **타임아웃**: 60초
- **재시도**: API 실패 시 1회 재시도
- **에러 메시지**:
  - API 호출 실패 → "분석 중 오류가 발생했습니다. 다시 시도해주세요."
  - 타임아웃 → "요청 시간이 초과되었습니다. 다시 시도해주세요."
  - 잔여 횟수 부족 → "검사 횟수가 부족합니다. 구독 페이지로 이동하시겠습니까?"

---

### 6.3 구독 관리 (토스페이먼츠)

#### 6.3.1 구독 정책
- **무료 요금제**:
  - 초기 3회 분석 가능
  - gemini-2.5-flash 모델 사용
  - 3회 소진 후 추가 분석 불가
  - Pro 구독으로 업그레이드 가능

- **Pro 요금제**:
  - 월 9,900원 (자동결제)
  - 월 10회 분석 가능
  - gemini-2.5-pro 모델 사용 (더 정교한 분석)
  - 고급 분석 포함 (직업운, 사업운, 월별 운세)
  - 언제든지 취소 가능

#### 6.3.2 구독 라이프사이클

**신규 구독**:
1. 토스페이먼츠 결제창 표시 (SDK)
2. 카드 정보 입력 및 본인인증
3. authKey 수신
4. 빌링키 발급 (서버)
5. Supabase에 빌링키 저장
6. 첫 결제 진행 (9,900원)
7. 구독 상태: 활성
8. 월 10회 검사 횟수 추가
9. 다음 결제일 설정 (30일 후)

**구독 취소**:
1. 사용자가 "구독 취소" 버튼 클릭
2. 취소 확인 다이얼로그 표시
3. 구독 상태: 취소 예약
4. 다음 결제일까지 Pro 혜택 유지
5. 다음 결제일 전까지 "구독 재개" 가능

**구독 재개**:
1. 사용자가 "구독 재개" 버튼 클릭
2. 구독 상태: 활성
3. 다음 결제일에 자동 결제 재개

**구독 해지 (다음 결제일 도달)**:
1. Supabase Cron Job이 매일 오전 2시 실행
2. 다음 결제일이 지난 '취소 예약' 구독 조회
3. 빌링키 삭제 (토스페이먼츠 API 호출)
4. 구독 상태: 해지
5. 사용자는 무료 요금제로 전환 (월 0회)

**정기 결제 (매월)**:
1. Supabase Cron Job이 매일 오전 2시 실행
2. 오늘이 결제일인 '활성' 구독 조회
3. 자동결제 승인 API 호출 (빌링키 사용)
4. 결제 성공:
   - 월 10회 검사 횟수 추가
   - 다음 결제일 업데이트 (30일 후)
5. 결제 실패:
   - 구독 상태: 결제 실패
   - 사용자에게 이메일 알림
   - 재시도 로직 (3일 후)

#### 6.3.3 토스페이먼츠 연동
- **SDK**: `@tosspayments/tosspayments-sdk`
- **결제수단**: 카드 (국내 카드만 지원)
- **빌링키 방식**: 최초 1회 본인인증 후 자동결제
- **Webhook 이벤트**:
  - `PAYMENT_STATUS_CHANGED`: 결제 상태 변경
  - `BILLING_DELETED`: 구매자가 카드 삭제
  - `DEPOSIT_CALLBACK`: 가상계좌 입금
- **보안**:
  - customerKey는 UUID 사용 (유추 불가)
  - 시크릿 키는 서버에서만 사용
  - 빌링키는 암호화하여 저장

---

### 6.4 데이터베이스 (Supabase)

#### 6.4.1 테이블 구조

**users 테이블**
| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | uuid | PK | 사용자 고유 ID (Clerk user ID) |
| email | varchar | NOT NULL, UNIQUE | 이메일 주소 |
| name | varchar | NOT NULL | 사용자 이름 |
| subscription_status | varchar | NOT NULL, DEFAULT 'free' | 구독 상태 (free/pro/cancelled/terminated) |
| test_count | integer | NOT NULL, DEFAULT 3 | 잔여 검사 횟수 |
| created_at | timestamp | NOT NULL, DEFAULT NOW() | 가입 날짜 |
| updated_at | timestamp | NOT NULL, DEFAULT NOW() | 정보 수정 날짜 |

**saju_tests 테이블**
| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | uuid | PK | 사주분석 고유 ID |
| user_id | uuid | FK (users.id), NOT NULL | 사용자 ID |
| name | varchar | NOT NULL | 분석 대상 이름 |
| birth_date | date | NOT NULL | 생년월일 |
| birth_time | time | NULL | 출생시간 (선택) |
| gender | varchar | NOT NULL | 성별 (male/female) |
| result | text | NOT NULL | 사주분석 결과 (마크다운) |
| model_used | varchar | NOT NULL | 사용된 모델 (flash/pro) |
| created_at | timestamp | NOT NULL, DEFAULT NOW() | 분석 날짜 |

**subscriptions 테이블**
| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | uuid | PK | 구독 고유 ID |
| user_id | uuid | FK (users.id), NOT NULL | 사용자 ID |
| billing_key | varchar | NOT NULL | 토스페이먼츠 빌링키 |
| customer_key | varchar | NOT NULL | 토스페이먼츠 customerKey (UUID) |
| card_number | varchar | NULL | 카드 번호 (마지막 4자리) |
| card_type | varchar | NULL | 카드 타입 (체크/신용) |
| card_company | varchar | NULL | 카드사 |
| status | varchar | NOT NULL, DEFAULT 'active' | 구독 상태 (active/cancelled/terminated/payment_failed) |
| next_billing_date | timestamp | NOT NULL | 다음 결제일 |
| last_billing_date | timestamp | NULL | 마지막 결제일 |
| billing_key_deleted_at | timestamp | NULL | 빌링키 삭제 일시 |
| created_at | timestamp | NOT NULL, DEFAULT NOW() | 구독 시작일 |
| updated_at | timestamp | NOT NULL, DEFAULT NOW() | 정보 수정 날짜 |

**payments 테이블**
| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | uuid | PK | 결제 고유 ID |
| user_id | uuid | FK (users.id), NOT NULL | 사용자 ID |
| subscription_id | uuid | FK (subscriptions.id), NOT NULL | 구독 ID |
| payment_key | varchar | NOT NULL | 토스페이먼츠 paymentKey |
| order_id | varchar | NOT NULL, UNIQUE | 주문 ID |
| amount | integer | NOT NULL | 결제 금액 |
| status | varchar | NOT NULL | 결제 상태 (done/cancelled/failed) |
| paid_at | timestamp | NOT NULL | 결제 완료 일시 |
| cancelled_at | timestamp | NULL | 취소 일시 |
| created_at | timestamp | NOT NULL, DEFAULT NOW() | 레코드 생성 일시 |

#### 6.4.2 인덱스
- `saju_tests.user_id` - 사용자별 분석 조회 최적화
- `saju_tests.created_at` - 날짜별 정렬 최적화
- `subscriptions.user_id` - 사용자별 구독 조회 최적화
- `subscriptions.status` - 구독 상태별 조회 최적화
- `subscriptions.next_billing_date` - 결제일별 조회 최적화
- `payments.user_id` - 사용자별 결제 조회 최적화
- `payments.order_id` - 주문 ID 조회 최적화

#### 6.4.3 Row Level Security (RLS)
- **users 테이블**: 본인 레코드만 읽기 가능
- **saju_tests 테이블**: 본인 분석만 읽기/쓰기 가능
- **subscriptions 테이블**: 본인 구독만 읽기/쓰기 가능
- **payments 테이블**: 본인 결제 내역만 읽기 가능

#### 6.4.4 Cron Job (Supabase pg_cron)
- **실행 시간**: 매일 오전 2시
- **작업**:
  1. 오늘이 결제일인 활성 구독 조회
  2. 자동결제 승인 API 호출
  3. 결제 성공 시 검사 횟수 추가 및 다음 결제일 업데이트
  4. 결제 실패 시 구독 상태 변경 및 알림
  5. 취소 예약 구독 중 결제일이 지난 것 조회
  6. 빌링키 삭제 및 구독 해지

---

### 6.5 UI/UX 요구사항

#### 6.5.1 반응형 디자인
- **모바일**: 320px ~ 767px
- **태블릿**: 768px ~ 1023px
- **데스크톱**: 1024px 이상

#### 6.5.2 컴포넌트
- **Button**: Primary, Secondary, Ghost, Destructive
- **Card**: 사주분석 이력 카드, 구독 정보 카드
- **Form**: Input, DatePicker, TimePicker, RadioGroup, Checkbox
- **Loading**: Spinner, Skeleton, Progress (스트리밍용)
- **Toast**: 성공/에러/정보 메시지
- **Dialog**: 확인 다이얼로그, 알림 다이얼로그, 스트리밍 다이얼로그
- **Markdown Renderer**: 사주분석 결과 렌더링
- **Badge**: 요금제 표시, 상태 표시

#### 6.5.3 접근성 (Accessibility)
- **키보드 네비게이션**: 모든 인터랙션 가능
- **ARIA 속성**: 스크린 리더 지원
- **색상 대비**: WCAG AA 기준 준수

---

## 7. 비기능 요구사항

### 7.1 성능
- **페이지 로드**: 3초 이내 (First Contentful Paint)
- **API 응답**: 사주분석 제외 1초 이내
- **사주분석 응답**:
  - gemini-2.5-flash: 20초 이내
  - gemini-2.5-pro: 40초 이내

### 7.2 보안
- **인증**: Clerk JWT 기반
- **데이터 암호화**: HTTPS 통신
- **XSS 방지**: React 자동 이스케이프
- **CSRF 방지**: Clerk 자동 처리
- **환경 변수**: 모든 API 키는 서버 사이드에서만 사용
- **빌링키 보안**: 암호화하여 저장, 로그 노출 금지
- **customerKey**: UUID 사용 (유추 불가능)

### 7.3 확장성
- **데이터베이스**: Supabase 자동 스케일링
- **API**: Vercel Serverless Functions
- **캐싱**: Vercel Edge Network
- **결제**: 토스페이먼츠 자동결제 (빌링키 방식)

### 7.4 모니터링
- **에러 추적**: Console 로그
- **API 사용량**: Gemini API 호출 횟수 추적
- **결제 모니터링**: 토스페이먼츠 개발자센터
- **사용자 분석**: 기본 메트릭 (페이지뷰, 세션)

---

## 8. 구독 및 결제 정책

### 8.1 요금제 비교

| 항목 | 무료 요금제 | Pro 요금제 |
|------|------------|-----------|
| 가격 | 무료 | 월 9,900원 |
| 월 검사 횟수 | 초기 3회 (소진 후 0회) | 월 10회 |
| 사용 모델 | gemini-2.5-flash | gemini-2.5-pro |
| 분석 수준 | 기본 분석 | 고급 분석 (직업운, 사업운, 월별 운세 포함) |
| 응답 속도 | 빠름 (10-20초) | 보통 (20-40초) |
| 결제 방식 | - | 자동결제 (카드) |
| 취소 정책 | - | 언제든지 취소 가능, 다음 결제일까지 혜택 유지 |

### 8.2 구독 취소 정책
- **즉시 취소 불가**: 다음 결제일까지 Pro 혜택 유지
- **구독 재개 가능**: 다음 결제일 전까지 언제든지 재개 가능
- **빌링키 삭제**: 다음 결제일 도달 시 자동 삭제
- **환불 불가**: 이미 결제된 금액은 환불 불가 (다음 결제일까지 사용 가능)

### 8.3 결제 실패 처리
- **결제 실패 시**: 구독 상태를 '결제 실패'로 변경
- **재시도**: 3일 후 1회 재시도
- **재시도 실패 시**: 구독 자동 해지, 빌링키 삭제
- **사용자 알림**: 이메일로 결제 실패 알림

---

## 9. 제외 사항

### 9.1 소셜 기능
- 사주분석 결과 공유 기능 없음
- SNS 연동 없음

### 9.2 관리자 페이지
- 별도 관리자 대시보드 없음

### 9.3 기타
- 궁합 분석 기능 없음
- PDF 다운로드 기능 없음
- 전문가 상담 예약 없음

---

## 10. 향후 고려사항

### 10.1 Phase 2 기능 후보
- 사주분석 결과 PDF 다운로드
- 사주분석 결과 공유 기능 (링크 공유)
- 궁합 분석 기능
- 연간 구독 모델 도입 (할인 혜택)
- 전문가 상담 예약
- 모바일 앱 (React Native)

### 10.2 개선 방향
- AI 프롬프트 고도화
- 분석 결과 시각화 (차트, 그래프)
- 다국어 지원 (영어, 일본어)
- 푸시 알림 (결제일 알림, 검사 횟수 소진 알림)

---

## 11. 출시 일정 (예상)

| 단계 | 작업 내용 | 기간 |
|------|----------|------|
| 1 | 기술 스택 설정 및 프로젝트 초기화 | 1일 |
| 2 | Clerk 인증 연동 | 1일 |
| 3 | Supabase DB 설계 및 연동 | 1일 |
| 4 | 홈페이지 및 랜딩 페이지 개발 | 2일 |
| 5 | 대시보드 개발 | 1일 |
| 6 | 새 검사하기 페이지 개발 | 2일 |
| 7 | Gemini API 연동 및 스트리밍 구현 | 2일 |
| 8 | 사주분석 상세 페이지 개발 | 1일 |
| 9 | 토스페이먼츠 결제 연동 | 2일 |
| 10 | 구독 관리 페이지 개발 | 1일 |
| 11 | Supabase Cron Job 설정 | 1일 |
| 12 | UI/UX 개선 및 반응형 처리 | 2일 |
| 13 | 테스트 및 버그 수정 | 3일 |
| 14 | 배포 및 Webhook 설정 | 1일 |
| **총 기간** | | **21일** |

---

## 12. 성공 지표 (KPI)

### 12.1 사용자 지표
- **신규 가입자 수**: 월 100명 목표
- **재방문율**: 30% 이상
- **평균 세션 시간**: 5분 이상
- **무료 → Pro 전환율**: 10% 목표

### 12.2 기술 지표
- **페이지 로드 속도**: 3초 이내
- **API 성공률**: 95% 이상
- **에러율**: 5% 이하
- **결제 성공률**: 90% 이상

### 12.3 비즈니스 지표
- **분석 완료율**: 70% 이상 (폼 시작 대비)
- **사용자당 평균 분석 횟수**: 2회 이상
- **월간 반복 매출 (MRR)**: 1,000,000원 목표 (101명 Pro 구독자)
- **구독 해지율 (Churn Rate)**: 10% 이하

---

## 13. 참고 자료

### 13.1 기술 문서
- [Clerk Documentation](https://clerk.com/docs)
- [Supabase Documentation](https://supabase.com/docs)
- [Google Gemini API](https://ai.google.dev/docs)
- [토스페이먼츠 개발자센터](https://developers.tosspayments.com)
- [Next.js App Router](https://nextjs.org/docs/app)

### 13.2 디자인 참고
- [shadcn/ui](https://ui.shadcn.com/)
- [Tailwind CSS](https://tailwindcss.com/)

---

## 문서 이력

| 버전 | 날짜 | 작성자 | 변경 내역 |
|------|------|--------|----------|
| 1.0 | 2025-10-26 | Claude Code | 초안 작성 |
| 2.0 | 2025-10-28 | Claude Code | 구독 관리 기능 추가, 전체 페이지 구조 개선 |
