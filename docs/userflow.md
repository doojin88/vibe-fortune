# Userflow 명세서

## 목차
1. [사용자 타입별 Userflow](#1-사용자-타입별-userflow)
2. [회원가입/로그인 플로우](#2-회원가입로그인-플로우)
3. [새 사주분석 요청 플로우](#3-새-사주분석-요청-플로우)
4. [사주분석 이력 조회 플로우](#4-사주분석-이력-조회-플로우)
5. [사주분석 상세 조회 플로우](#5-사주분석-상세-조회-플로우)
6. [구독 관리 플로우](#6-구독-관리-플로우)
7. [예외 상황 및 에러 처리](#7-예외-상황-및-에러-처리)

---

## 1. 사용자 타입별 Userflow

### 1.1 신규 사용자 (미가입)

#### 입력
- 홈페이지 접속
- Hero 섹션 탐색
- 시작하기 버튼 클릭

#### 처리
1. 사용자가 시작하기 버튼 클릭
2. 시스템이 인증 상태 확인
3. 비로그인 상태 감지
4. Clerk 로그인 페이지로 리다이렉트
5. 사용자가 Google 계정 선택
6. Google OAuth 인증 프로세스 진행
7. Clerk가 JWT 토큰 생성
8. Clerk Webhook이 user.created 이벤트 발행
9. 서버가 Webhook 수신
10. Supabase users 테이블에 신규 레코드 생성
    - subscription_status: 'free' (기본값)
    - test_count: 3 (기본값)
11. 인증 완료 후 대시보드로 리다이렉트

#### 출력
- Clerk 로그인 페이지 표시
- 로그인 성공 시 대시보드로 이동
- 빈 상태 화면 표시
- 첫 검사 시작하기 버튼 제공
- 사이드바에 무료 요금제 정보 표시 (잔여 3회)

#### 엣지케이스
- Google OAuth 인증 취소: 홈페이지로 리턴
- Google 계정 없음: OAuth 프로세스 중단, 계정 생성 안내
- 네트워크 에러: 재시도 버튼 표시
- Webhook 실패: 백그라운드에서 재시도, 사용자 플로우는 계속 진행

---

### 1.2 무료 사용자 (검사 횟수 보유)

#### 시나리오 A: 새 분석 요청 (잔여 횟수 있음)

##### 입력
- 대시보드 접근
- 새 검사하기 버튼 클릭
- 분석 정보 입력

##### 처리
1. 사용자가 대시보드 접근
2. 사이드바에서 잔여 횟수 확인 (예: 2회)
3. 새 검사하기 버튼 클릭
4. 새 검사하기 페이지 렌더링
5. 사용자가 필수 정보 입력
6. 검사 시작 버튼 클릭
7. 서버에서 잔여 횟수 확인 (test_count >= 1)
8. Gemini API 호출 (gemini-2.5-flash 모델 사용)
9. 분석 완료 후 Supabase에 저장
10. test_count 1 감소 (예: 2 → 1)
11. 상세 페이지로 리다이렉트

##### 출력
- 분석 진행 중 로딩 다이얼로그 표시
- 분석 완료 alert 표시
- 사주분석 상세 페이지로 이동
- 사이드바에서 업데이트된 잔여 횟수 확인 (1회)

##### 엣지케이스
- 동시 다중 요청으로 test_count 충돌: 데이터베이스 트랜잭션으로 방지
- API 호출 실패 시 test_count 차감 안함: 트랜잭션 롤백
- 분석 중 세션 만료: 입력 데이터 임시 저장, 재로그인 후 복구

---

#### 시나리오 B: 검사 횟수 소진 후 구독 유도

##### 입력
- 잔여 횟수 0회 상태에서 새 검사하기 시도

##### 처리
1. 사용자가 대시보드에서 잔여 횟수 0회 확인
2. 새 검사하기 버튼 클릭
3. 서버에서 test_count 확인 (test_count === 0)
4. 다이얼로그 표시
   - 제목: "검사 횟수가 부족합니다"
   - 메시지: "Pro 구독을 통해 월 10회 고급 분석을 이용하세요"
   - 버튼: "구독하기", "취소"
5. 사용자가 구독하기 선택
6. 구독 관리 페이지로 리다이렉트

##### 출력
- 검사 횟수 부족 다이얼로그 표시
- 구독 관리 페이지로 이동
- Pro 요금제 혜택 안내

##### 엣지케이스
- 취소 버튼 클릭: 대시보드로 복귀
- 다이얼로그 외부 클릭: 대시보드로 복귀
- 사이드바의 구독 상태 클릭: 직접 구독 관리 페이지 접근

---

### 1.3 무료 사용자 → Pro 구독 전환

#### 입력
- 구독 관리 페이지 접근
- Pro 구독하기 버튼 클릭

#### 처리
1. 사용자가 구독 관리 페이지 접근
2. 현재 구독 상태 표시
   - 요금제: 무료
   - 잔여 횟수: 0회
3. Pro 요금제 혜택 표시
   - 월 9,900원
   - 월 10회 분석
   - gemini-2.5-pro 모델 사용
   - 고급 분석 (직업운, 사업운, 월별 운세)
4. Pro 구독하기 버튼 클릭
5. 토스페이먼츠 SDK 초기화
6. 결제창 렌더링
7. 사용자가 카드 정보 입력
8. 본인인증 진행
9. authKey 수신
10. 서버로 authKey 전송
11. 서버에서 빌링키 발급 API 호출
12. 빌링키 수신 및 Supabase에 저장
    - subscriptions 테이블에 레코드 생성
    - billing_key, customer_key 저장
    - status: 'active'
    - next_billing_date: 현재 + 30일
13. 첫 결제 승인 API 호출 (9,900원)
14. 결제 성공 시:
    - payments 테이블에 레코드 생성
    - users.subscription_status → 'pro'
    - users.test_count → 10 설정
15. 구독 관리 페이지로 리다이렉트

#### 출력
- 토스페이먼츠 결제창 표시
- 결제 진행 로딩 표시
- 결제 완료 후 구독 관리 페이지로 이동
- Pro 구독 상태 표시
- 사이드바에서 Pro 요금제 및 잔여 10회 확인

#### 엣지케이스
- 결제창 닫기: 구독 관리 페이지로 복귀, 구독 미완료 상태
- 카드 정보 오류: 에러 메시지 표시, 재입력 유도
- 본인인증 실패: 인증 재시도 안내
- 빌링키 발급 실패: 에러 메시지, 고객센터 안내
- 첫 결제 실패: 빌링키 삭제, 구독 미완료 처리
- 중복 구독 시도: 이미 구독 중 메시지, 현재 구독 정보 표시

---

### 1.4 Pro 구독자 (활성)

#### 시나리오 A: 새 분석 요청

##### 입력
- 새 검사하기 버튼 클릭
- 분석 정보 입력

##### 처리
1. 사용자가 새 검사하기 페이지 접근
2. 사이드바에서 Pro 구독 정보 확인
   - 요금제: Pro
   - 잔여 횟수: 8회
   - 다음 결제일: 2025-11-28
3. 필수 정보 입력
4. 검사 시작 버튼 클릭
5. 서버에서 구독 상태 확인 (subscription_status === 'pro')
6. Gemini API 호출 (gemini-2.5-pro 모델 사용)
7. Pro 전용 고급 프롬프트 사용
8. 분석 완료 후 저장
9. test_count 1 감소 (8 → 7)
10. 상세 페이지로 리다이렉트

##### 출력
- 로딩 다이얼로그 표시 (20-40초 예상)
- 실시간 스트리밍으로 분석 결과 확인
- 고급 분석 결과 표시 (직업운, 사업운, 월별 운세 포함)
- 사이드바에서 업데이트된 잔여 횟수 확인 (7회)

##### 엣지케이스
- 분석 중 구독 만료: 분석은 완료, 이후 무료 모델 전환
- Pro 모델 API 실패: flash 모델로 폴백, 사용자에게 안내
- test_count 0이지만 구독 활성: 정상 진행, 다음 결제일 안내

---

#### 시나리오 B: 구독 취소 요청

##### 입력
- 구독 관리 페이지 접근
- 구독 취소 버튼 클릭

##### 처리
1. 사용자가 구독 관리 페이지 접근
2. 현재 구독 정보 표시
   - 요금제: Pro
   - 잔여 횟수: 7회
   - 다음 결제일: 2025-11-28
   - 구독 시작일: 2025-10-28
3. 구독 취소 버튼 클릭
4. 확인 다이얼로그 표시
   - 제목: "구독을 취소하시겠습니까?"
   - 메시지: "다음 결제일(2025-11-28)까지 Pro 혜택이 유지됩니다."
   - 버튼: "취소", "확인"
5. 사용자가 확인 클릭
6. 서버로 취소 요청 전송
7. Supabase subscriptions.status → 'cancelled' 업데이트
8. users.subscription_status → 'cancelled' 업데이트
9. 구독 관리 페이지 리로드

#### 출력
- 취소 확인 다이얼로그 표시
- 취소 완료 후 구독 관리 페이지 업데이트
- 구독 상태: Pro (취소 예약)
- 다음 결제일까지 Pro 혜택 유지 안내
- 구독 재개 버튼 표시
- 사이드바에서 취소 예약 상태 표시

#### 엣지케이스
- 취소 다이얼로그에서 취소 버튼: 구독 유지
- 다음 결제일 당일 취소: 당일까지 Pro 혜택 유지
- 이미 취소 예약된 구독 다시 취소: 이미 취소 예약됨 메시지
- 결제일 전날 취소: 정상 처리, 익일 자동 해지

---

### 1.5 Pro 구독자 (취소 예약)

#### 시나리오 A: 구독 재개

##### 입력
- 구독 관리 페이지 접근
- 구독 재개 버튼 클릭

##### 처리
1. 사용자가 구독 관리 페이지 접근
2. 현재 구독 정보 표시
   - 요금제: Pro (취소 예약)
   - 잔여 횟수: 5회
   - 다음 결제일: 2025-11-28 (해지 예정)
3. 구독 재개 버튼 클릭
4. 확인 다이얼로그 표시
   - 제목: "구독을 재개하시겠습니까?"
   - 메시지: "다음 결제일(2025-11-28)에 자동 결제가 진행됩니다."
   - 버튼: "취소", "확인"
5. 사용자가 확인 클릭
6. 서버로 재개 요청 전송
7. Supabase subscriptions.status → 'active' 업데이트
8. users.subscription_status → 'pro' 업데이트
9. 구독 관리 페이지 리로드

##### 출력
- 재개 확인 다이얼로그 표시
- 재개 완료 후 구독 관리 페이지 업데이트
- 구독 상태: Pro (활성)
- 다음 결제일 자동 결제 안내
- 구독 취소 버튼 표시
- 사이드바에서 활성 상태 표시

##### 엣지케이스
- 다음 결제일 이후 재개 시도: 이미 해지된 구독, 신규 구독 필요
- 재개 후 즉시 다시 취소: 정상 처리, 다시 취소 예약 상태
- 빌링키 만료된 경우: 재개 불가, 신규 구독 필요

---

#### 시나리오 B: 다음 결제일 도달 시 자동 해지

##### 입력
- Supabase Cron Job 실행 (매일 오전 2시)

##### 처리
1. Cron Job이 오전 2시에 실행
2. 취소 예약 상태(status === 'cancelled') 구독 조회
3. 다음 결제일이 오늘 이전인 구독 필터링
4. 각 구독에 대해:
   - 토스페이먼츠 빌링키 삭제 API 호출
   - subscriptions.status → 'terminated' 업데이트
   - subscriptions.billing_key_deleted_at → 현재 시각
   - users.subscription_status → 'free' 업데이트
   - users.test_count → 0 설정 (무료 3회는 초기에만 제공)

##### 출력
- 자동으로 무료 요금제로 전환
- 사용자 다음 로그인 시:
  - 사이드바에 무료 요금제 표시
  - 잔여 횟수: 0회
  - Pro 구독하기 버튼 표시

##### 엣지케이스
- 빌링키 삭제 API 실패: 재시도 큐에 추가, 다음 Cron 실행 시 재시도
- 동시 다중 구독 해지: 각각 독립적으로 처리
- 사용자가 해지 당일 서비스 이용 중: 트랜잭션 완료 후 상태 변경

---

### 1.6 Pro 구독자 (정기 결제)

#### 입력
- Supabase Cron Job 실행 (매일 오전 2시)

#### 처리
1. Cron Job이 오전 2시에 실행
2. 활성 상태(status === 'active') 구독 조회
3. 다음 결제일이 오늘인 구독 필터링
4. 각 구독에 대해:
   - 토스페이먼츠 자동결제 승인 API 호출
   - 빌링키로 9,900원 결제
5. 결제 성공 시:
   - payments 테이블에 레코드 생성
   - users.test_count → 10으로 재설정
   - subscriptions.next_billing_date → 현재 + 30일
   - subscriptions.last_billing_date → 현재
6. 결제 실패 시:
   - subscriptions.status → 'payment_failed' 업데이트
   - users.subscription_status → 'payment_failed'
   - 이메일 알림 발송
   - 3일 후 재시도 스케줄링

#### 출력
- 결제 성공: 사용자 인지 못함, 자동으로 검사 횟수 충전
- 결제 실패: 이메일 알림 수신, 다음 로그인 시 결제 실패 안내

#### 엣지케이스
- 카드 한도 초과: 결제 실패, 재시도 안내
- 카드 만료: 결제 실패, 카드 정보 업데이트 요청
- 3일 후 재시도 실패: 구독 자동 해지, 빌링키 삭제
- 결제 중 사용자가 구독 취소 시도: 결제 완료 후 취소 예약 처리
- 동시 다중 결제 방지: 트랜잭션으로 중복 방지

---

### 1.7 재방문 사용자 (가입 완료)

#### 시나리오 A: 과거 결과 재확인

##### 입력
- 홈페이지 또는 직접 대시보드 URL 접속
- 이력 카드 클릭

##### 처리
1. 사용자가 URL 접속
2. 시스템이 Clerk 세션 확인
3. 유효한 세션 존재 확인
4. 대시보드 페이지 렌더링
5. Supabase에서 사용자 ID로 사주분석 이력 조회
6. created_at 기준 내림차순 정렬
7. 이력 카드 목록 렌더링
8. 사용자가 특정 카드 클릭
9. 해당 분석 ID로 상세 페이지 이동

##### 출력
- 대시보드 페이지 표시
- 사주분석 이력 카드 목록 표시
- 선택한 분석 상세 페이지 표시

##### 엣지케이스
- 세션 만료: Clerk 자동 로그인 페이지 리다이렉트
- 이력 없음: 빈 상태 화면 표시
- 데이터베이스 연결 실패: 에러 메시지 및 재시도 버튼
- 이력 데이터 손상: 해당 카드만 에러 표시, 나머지는 정상 렌더링

---

## 2. 회원가입/로그인 플로우

### 2.1 로그인 플로우

#### 입력
- 시작하기 또는 이용하기 버튼 클릭
- 또는 보호된 페이지 직접 접근 시도

#### 처리
1. 사용자가 CTA 버튼 클릭 또는 보호된 URL 접근
2. 시스템이 Clerk 세션 확인
3. 세션 없음 감지
4. 현재 URL을 returnUrl 파라미터로 저장
5. Clerk SignIn 컴포넌트로 리다이렉트
6. Clerk가 로그인 페이지 렌더링
7. Google 로그인 버튼 표시
8. 사용자가 Google 로그인 선택
9. Google OAuth 동의 화면 표시
10. 사용자가 동의 및 계정 선택
11. Google이 인증 코드 반환
12. Clerk가 JWT 토큰 생성 및 세션 생성
13. returnUrl로 리다이렉트 (없으면 대시보드로)

#### 출력
- Clerk 로그인 페이지 표시
- Google OAuth 동의 화면
- 로그인 성공 시 원래 목적지 페이지로 이동

#### 엣지케이스
- Google 계정 선택 취소: 로그인 페이지로 복귀
- OAuth 권한 거부: 에러 메시지 표시
- 네트워크 단절: 재시도 안내 메시지
- 다른 OAuth 제공자 클릭: 지원하지 않음 메시지

---

### 2.2 자동 회원가입 플로우

#### 입력
- 최초 Google 로그인 시도

#### 처리
1. 사용자가 Google 로그인 선택
2. Google OAuth 인증 완료
3. Clerk가 해당 이메일 계정 조회
4. 기존 계정 없음 확인
5. Clerk가 자동으로 신규 계정 생성
6. user.created Webhook 이벤트 발행
7. 배포된 웹훅 엔드포인트로 POST 요청
8. 서버가 Webhook 검증
9. 사용자 정보 추출 (id, email, name)
10. Supabase users 테이블에 INSERT
    - subscription_status: 'free'
    - test_count: 3
11. 생성 완료 응답 반환
12. Clerk 세션 생성
13. 대시보드로 리다이렉트

#### 출력
- 회원가입 완료
- 대시보드 페이지 표시
- 빈 상태 안내
- 사이드바에 무료 요금제 정보 표시 (잔여 3회)

#### 엣지케이스
- Webhook 엔드포인트 접근 불가: 재시도 큐에 추가
- Supabase 연결 실패: 에러 로깅, 재시도
- 중복 이메일 (동시 요청): UNIQUE 제약으로 방지, 첫 요청만 성공
- Webhook 서명 검증 실패: 요청 거부, 로그 기록

---

### 2.3 로그아웃 플로우

#### 입력
- UserButton에서 로그아웃 선택

#### 처리
1. 사용자가 UserButton 클릭
2. Clerk 메뉴 표시
3. 로그아웃 옵션 클릭
4. Clerk가 세션 무효화
5. JWT 토큰 삭제
6. 브라우저 쿠키 삭제
7. 홈페이지로 리다이렉트

#### 출력
- 로그아웃 완료
- 홈페이지 표시
- 시작하기 버튼 표시

#### 엣지케이스
- 네트워크 에러: 로컬 세션만 삭제, 백그라운드에서 서버 세션 무효화 재시도
- 이미 만료된 세션: 정상 처리, 홈으로 리다이렉트

---

## 3. 새 사주분석 요청 플로우

### 3.1 폼 입력 및 검증

#### 입력
- 성함 텍스트 입력
- 생년월일 선택 또는 입력
- 출생시간 선택 또는 입력
- 출생시간 모름 체크박스
- 성별 선택

#### 처리
1. 사용자가 새 검사하기 페이지 접속
2. 시스템이 빈 폼 렌더링
3. 각 필드가 onChange 이벤트 리스너 등록

**성함 입력:**
4. 사용자가 성함 필드에 입력
5. 실시간으로 길이 검증 (1-50자)
6. 유효성 상태 업데이트
7. 에러 있으면 필드 아래 메시지 표시

**생년월일 입력:**
8. 사용자가 DatePicker 클릭 또는 직접 입력
9. 날짜 형식 검증 (YYYY-MM-DD)
10. 범위 검증 (1900-01-01 ~ 오늘)
11. 유효성 상태 업데이트
12. 에러 있으면 필드 아래 메시지 표시

**출생시간 입력:**
13. 사용자가 TimePicker 클릭 또는 직접 입력
14. 시간 형식 검증 (HH:mm)
15. 출생시간 모름 체크박스 클릭 시:
    - 시간 입력 필드 비활성화
    - 값 null로 설정
16. 체크박스 해제 시:
    - 시간 입력 필드 활성화

**성별 선택:**
17. 사용자가 라디오 버튼 클릭
18. 선택 값 상태에 저장

**전체 검증:**
19. 모든 필수 필드 입력 상태 체크
20. 모든 필드 유효성 체크
21. 조건 충족 시 검사 시작 버튼 활성화
22. 조건 미충족 시 버튼 비활성화 유지

#### 출력
- 각 필드별 실시간 검증 결과
- 에러 메시지 (필요 시)
- 검사 시작 버튼 활성화 상태 변경

#### 엣지케이스
- 복사/붙여넣기 데이터: 붙여넣기 후 검증 수행
- 날짜 수동 입력 시 잘못된 형식: 에러 메시지 표시
- 미래 날짜 입력: 오늘 이전만 허용 메시지
- 1900년 이전 날짜: 1900년 이후만 허용 메시지
- 출생시간 모름 체크 후 체크 해제: 필드 재활성화, 값 유지되지 않음

---

### 3.2 잔여 횟수 확인

#### 입력
- 검사 시작 버튼 클릭

#### 처리
1. 사용자가 검사 시작 버튼 클릭
2. 폼 데이터 최종 검증
3. 검사 시작 버튼 비활성화
4. 서버 액션 함수 호출
5. 서버에서 사용자 인증 상태 재확인
6. Supabase에서 users.test_count 조회
7. test_count 값 확인

**케이스 A: test_count >= 1**
8. 다음 단계(분석 실행)로 진행

**케이스 B: test_count === 0**
9. 에러 응답 반환
10. 클라이언트에서 다이얼로그 표시
    - 제목: "검사 횟수가 부족합니다"
    - 메시지 내용:
      - 무료 사용자: "Pro 구독을 통해 월 10회 고급 분석을 이용하세요"
      - Pro 구독자: "다음 결제일에 검사 횟수가 충전됩니다 (다음 결제일 표시)"
    - 버튼:
      - 무료 사용자: "구독하기", "취소"
      - Pro 구독자: "확인"
11. 사용자가 구독하기 선택 시: 구독 관리 페이지로 이동
12. 사용자가 취소/확인 선택 시: 새 검사하기 페이지 유지

#### 출력
- test_count >= 1: 로딩 스피너 표시, 분석 진행
- test_count === 0: 검사 횟수 부족 다이얼로그 표시

#### 엣지케이스
- 동시 다중 요청으로 test_count 0이 되는 경우: 첫 요청만 성공, 나머지는 부족 메시지
- 검증 중 세션 만료: 로그인 페이지로 리다이렉트
- 네트워크 에러: 에러 메시지, 재시도 버튼

---

### 3.3 분석 실행

#### 입력
- test_count 확인 통과 후 자동 진행

#### 처리
1. 서버에서 입력 데이터 서버 측 검증
2. 사용자 구독 상태 확인 (subscription_status)
3. 구독 상태에 따른 모델 선택:
   - 'free': gemini-2.5-flash
   - 'pro' 또는 'cancelled': gemini-2.5-pro
4. 프롬프트 생성:
   - 입력 데이터 포맷팅
   - 구독 상태에 따른 프롬프트 템플릿 선택
   - Pro 구독자: 직업운, 사업운, 월별 운세 추가 요청
5. Gemini API 호출:
   - API 키 헤더 추가
   - 프롬프트 전송
   - 스트리밍 응답 수신
6. 클라이언트에 실시간 스트리밍:
   - 로딩 다이얼로그에서 진행 중인 결과 표시
7. AI 응답 완료
8. 마크다운 형식 검증
9. Supabase에 트랜잭션 시작:
   - saju_tests 테이블에 INSERT:
     - user_id, name, birth_date, birth_time, gender
     - result: AI 분석 결과
     - model_used: 사용된 모델 ('flash' 또는 'pro')
   - users.test_count 1 감소
   - 트랜잭션 커밋
10. 저장된 레코드 ID 반환
11. 완료 alert 표시
12. 사용자가 확인 클릭
13. 상세 페이지로 리다이렉트

#### 출력
- 로딩 다이얼로그 표시
- 실시간 스트리밍으로 진행 중인 분석 결과 확인
- 완료 alert: "사주분석이 완료되었습니다"
- 상세 페이지로 자동 이동

#### 엣지케이스
- API 호출 실패: 에러 메시지 토스트, test_count 차감 안함, 재시도 버튼
- 타임아웃 (60초 초과): 타임아웃 메시지, test_count 차감 안함, 재시도 안내
- 네트워크 단절: 연결 에러 메시지, test_count 차감 안함
- 응답 형식 불일치: 파싱 에러 처리, 재시도 또는 관리자 알림
- 데이터베이스 저장 실패: 에러 메시지, 트랜잭션 롤백으로 test_count 복구
- 스트리밍 중 세션 만료: 분석 완료까지 진행, 완료 후 재로그인 유도
- 동시 다중 요청 방지: 버튼 비활성화, 진행 중 표시
- Pro 모델 실패 시 flash 모델 폴백: 사용자에게 안내, test_count 정상 차감

---

### 3.4 분석 완료 및 이동

#### 입력
- 분석 완료 및 저장 성공

#### 처리
1. 서버 액션이 분석 ID 반환
2. 클라이언트가 ID 수신
3. 로딩 상태 종료
4. 완료 alert 표시
5. 사용자가 확인 클릭
6. router.push로 상세 페이지 이동
7. URL에 분석 ID 포함
8. 상세 페이지 컴포넌트 마운트
9. 해당 ID로 데이터 조회

#### 출력
- 완료 alert 표시
- 사주분석 상세 페이지로 이동
- 분석 결과 렌더링

#### 엣지케이스
- 리다이렉트 실패: 수동 링크 제공
- ID 누락: 대시보드로 이동, 최신 분석 표시

---

## 4. 사주분석 이력 조회 플로우

### 4.1 대시보드 접근

#### 입력
- 대시보드 URL 접속
- 또는 네비게이션 메뉴에서 대시보드 클릭

#### 처리
1. 사용자가 대시보드 접근
2. 시스템이 Clerk 세션 확인
3. 인증 상태 검증
4. 대시보드 페이지 컴포넌트 렌더링
5. 서버 컴포넌트에서 데이터 페칭:
   - 현재 사용자 ID 추출
   - Supabase users 테이블에서 구독 정보 조회
   - Supabase saju_tests 테이블 쿼리
   - WHERE user_id = current_user_id
   - ORDER BY created_at DESC
   - LIMIT 10 (페이지네이션)
6. 데이터 반환
7. 클라이언트 컴포넌트로 props 전달
8. 사이드바에 구독 정보 표시:
   - 이메일
   - 요금제 (무료/Pro/Pro(취소 예약))
   - 잔여 검사 횟수
   - 다음 결제일 (Pro인 경우)
9. 이력 카드 목록 렌더링

#### 출력
- 대시보드 페이지 표시
- 사이드바에 구독 상태 표시
- 사주분석 이력 카드 목록
- 각 카드에 이름, 생년월일, 성별, 날짜, 미리보기 표시

#### 엣지케이스
- 비로그인 상태: 로그인 페이지로 리다이렉트
- 이력 없음: 빈 상태 화면, 첫 검사 시작하기 버튼
- 데이터베이스 연결 실패: 에러 메시지, 재시도 버튼
- 느린 쿼리: 스켈레톤 로딩 표시
- 10개 이상 이력: 페이지네이션 또는 더보기 버튼

---

### 4.2 검색 및 필터링

#### 입력
- 검색바에 검사자 이름 입력

#### 처리
1. 사용자가 검색바에 텍스트 입력
2. 실시간으로 onChange 이벤트 발생
3. 디바운스 적용 (300ms)
4. 클라이언트 측에서 이력 목록 필터링
5. name 필드에 검색어 포함 여부 확인
6. 필터링된 결과 렌더링

#### 출력
- 검색어와 일치하는 이력 카드만 표시
- 일치하는 결과 없음: 빈 상태 메시지

#### 엣지케이스
- 검색어 없음: 전체 목록 표시
- 특수문자 입력: 이스케이프 처리
- 빈 공백만 입력: 전체 목록 표시

---

### 4.3 이력 페이지네이션

#### 입력
- 이력 목록 스크롤
- 더보기 버튼 클릭 (10개 이상 시)

#### 처리
1. 사용자가 스크롤 또는 더보기 클릭
2. 추가 데이터 페칭 요청
3. OFFSET 값 증가 (10, 20, 30...)
4. Supabase 쿼리 실행
5. 추가 이력 데이터 반환
6. 기존 목록에 append
7. 카드 렌더링

#### 출력
- 추가 이력 카드 표시
- 스크롤 위치 유지

#### 엣지케이스
- 더 이상 데이터 없음: 더보기 버튼 숨김
- 중복 요청 방지: 로딩 중 버튼 비활성화
- 네트워크 에러: 에러 메시지, 재시도 버튼

---

### 4.4 이력 카드 클릭

#### 입력
- 특정 이력 카드 클릭

#### 처리
1. 사용자가 카드 클릭
2. 카드의 data-id 속성에서 분석 ID 추출
3. router.push로 상세 페이지 이동
4. URL 파라미터에 ID 포함
5. 상세 페이지 렌더링

#### 출력
- 해당 분석 상세 페이지로 이동

#### 엣지케이스
- ID 없음: 대시보드에서 에러 메시지
- 잘못된 ID: 404 페이지 또는 대시보드로 리다이렉트

---

## 5. 사주분석 상세 조회 플로우

### 5.1 상세 페이지 접근

#### 입력
- 상세 페이지 URL 접근
- 또는 이력 카드 클릭

#### 처리
1. 사용자가 URL 접근
2. Next.js가 동적 라우트 파라미터 파싱
3. 분석 ID 추출
4. 시스템이 Clerk 세션 확인
5. 서버 컴포넌트에서 데이터 페칭:
   - Supabase saju_tests 테이블 쿼리
   - WHERE id = analysis_id AND user_id = current_user_id
6. 데이터 존재 여부 확인
7. 권한 검증 (본인 분석인지)
8. 데이터 반환
9. 상세 페이지 렌더링:
   - 분석 대상 정보 카드
   - 마크다운 결과 렌더링
   - 액션 버튼

#### 출력
- 사주분석 상세 페이지
- 분석 대상 정보 (이름, 생년월일, 출생시간, 성별, 분석 날짜)
- 마크다운으로 렌더링된 분석 결과
- 목록으로, 새 검사하기, 결과 복사 버튼

#### 엣지케이스
- 비로그인 상태: 로그인 페이지로 리다이렉트
- 존재하지 않는 ID: 404 페이지
- 다른 사용자의 분석 접근 시도: 404 또는 권한 없음 메시지
- 데이터베이스 연결 실패: 에러 메시지, 재시도 버튼
- 마크다운 파싱 에러: 원본 텍스트 표시

---

### 5.2 결과 복사

#### 입력
- 결과 복사 버튼 클릭

#### 처리
1. 사용자가 결과 복사 버튼 클릭
2. 분석 결과 텍스트 (마크다운) 추출
3. navigator.clipboard.writeText() 호출
4. 클립보드에 텍스트 복사
5. 성공 시 토스트 메시지 표시
6. 버튼 아이콘 변경 (체크 표시)
7. 2초 후 원래 아이콘으로 복구

#### 출력
- 클립보드에 마크다운 텍스트 복사
- 복사 완료 토스트 메시지

#### 엣지케이스
- 클립보드 API 미지원 브라우저: 폴백 메서드 사용 (textarea 생성, 복사, 삭제)
- 복사 실패: 에러 토스트 메시지
- 권한 거부 (HTTPS 아님): 권한 요청 또는 안내 메시지

---

### 5.3 네비게이션

#### 입력
- 목록으로 버튼 클릭
- 또는 새 검사하기 버튼 클릭

#### 처리
**목록으로:**
1. 사용자가 목록으로 버튼 클릭
2. router.push로 대시보드 이동
3. 대시보드 렌더링

**새 검사하기:**
1. 사용자가 새 검사하기 버튼 클릭
2. router.push로 새 검사 페이지 이동
3. 빈 폼 렌더링

#### 출력
- 해당 페이지로 이동

#### 엣지케이스
- 네비게이션 중 에러: 브라우저 뒤로가기 사용 안내

---

## 6. 구독 관리 플로우

### 6.1 구독 관리 페이지 접근

#### 입력
- 헤더 메뉴에서 구독관리 클릭
- 또는 사이드바 구독 상태 클릭
- 또는 검사 횟수 부족 시 구독하기 버튼 클릭

#### 처리
1. 사용자가 구독 관리 페이지 접근
2. 시스템이 Clerk 세션 확인
3. 서버 컴포넌트에서 데이터 페칭:
   - Supabase users 테이블 조회 (subscription_status, test_count)
   - subscriptions 테이블 조회 (구독 정보)
4. 구독 상태에 따른 UI 렌더링:
   - 무료 사용자 (subscription_status === 'free')
   - Pro 구독자 활성 (subscription_status === 'pro')
   - Pro 구독자 취소 예약 (subscription_status === 'cancelled')
   - 결제 실패 (subscription_status === 'payment_failed')

#### 출력
- 구독 관리 페이지 표시
- 현재 구독 정보:
  - 이메일 주소
  - 현재 요금제
  - 잔여 검사 횟수
  - 다음 결제일 (Pro인 경우)
  - 카드 정보 (Pro인 경우, 마지막 4자리)
- 구독 상태에 따른 액션 버튼

#### 엣지케이스
- 비로그인 상태: 로그인 페이지로 리다이렉트
- 데이터베이스 연결 실패: 에러 메시지, 재시도 버튼

---

### 6.2 무료 → Pro 구독 플로우

#### 입력
- Pro 구독하기 버튼 클릭

#### 처리
1. 사용자가 Pro 구독하기 버튼 클릭
2. 토스페이먼츠 SDK 로드 확인
3. 클라이언트에서 customerKey 생성 (UUID)
4. 결제 위젯 초기화
5. 결제창 렌더링
6. 사용자가 카드 정보 입력:
   - 카드 번호
   - 유효기간
   - CVC
   - 카드 소유자 이름
7. 본인인증 진행
8. 인증 성공 시 authKey 발급
9. 클라이언트가 서버로 authKey와 customerKey 전송
10. 서버에서 토스페이먼츠 빌링키 발급 API 호출:
    - authKey, customerKey 전송
    - billingKey 수신
11. 서버에서 Supabase에 저장:
    - subscriptions 테이블에 INSERT:
      - user_id, billing_key, customer_key
      - card_number (마지막 4자리), card_type, card_company
      - status: 'active'
      - next_billing_date: 현재 + 30일
      - created_at: 현재
12. 서버에서 첫 결제 승인 API 호출:
    - 빌링키 사용
    - 금액: 9,900원
    - 주문 ID 생성
13. 결제 성공 시:
    - payments 테이블에 INSERT
    - users.subscription_status → 'pro'
    - users.test_count → 10
    - subscriptions.last_billing_date → 현재
14. 결제 실패 시:
    - 빌링키 삭제
    - subscriptions 레코드 삭제
    - 에러 메시지 반환
15. 클라이언트로 결과 반환
16. 구독 관리 페이지 리다이렉트

#### 출력
- 토스페이먼츠 결제창 표시
- 결제 진행 중 로딩 표시
- 결제 성공 토스트 메시지
- 구독 관리 페이지로 이동
- Pro 구독 상태 표시

#### 엣지케이스
- 결제창 닫기: 구독 관리 페이지로 복귀, 구독 미완료
- 카드 정보 오류: 토스페이먼츠 에러 메시지 표시, 재입력 유도
- 본인인증 실패: 인증 재시도 안내
- 빌링키 발급 실패: 에러 메시지, 고객센터 안내
- 첫 결제 실패: 빌링키 삭제, 에러 메시지, 재시도 안내
- 중복 구독 시도: 이미 구독 중 메시지, 현재 구독 정보 표시
- 네트워크 에러: 에러 메시지, 재시도 버튼
- SDK 로드 실패: 페이지 새로고침 안내

---

### 6.3 Pro 구독 취소 플로우

#### 입력
- 구독 취소 버튼 클릭

#### 처리
1. 사용자가 구독 취소 버튼 클릭
2. 확인 다이얼로그 표시:
   - 제목: "구독을 취소하시겠습니까?"
   - 메시지: "다음 결제일(YYYY-MM-DD)까지 Pro 혜택이 유지됩니다."
   - 안내: "다음 결제일 전까지 언제든지 구독을 재개할 수 있습니다."
   - 버튼: "취소", "확인"
3. 사용자가 취소 선택: 다이얼로그 닫힘, 구독 유지
4. 사용자가 확인 선택:
5. 서버로 취소 요청 전송
6. 서버에서 Supabase 업데이트:
   - subscriptions.status → 'cancelled'
   - users.subscription_status → 'cancelled'
7. 성공 응답 반환
8. 구독 관리 페이지 리로드
9. 업데이트된 구독 정보 표시

#### 출력
- 취소 확인 다이얼로그 표시
- 취소 처리 중 로딩 표시
- 취소 완료 토스트 메시지
- 구독 관리 페이지 업데이트
- 구독 상태: Pro (취소 예약)
- 다음 결제일까지 혜택 유지 안내
- 구독 재개 버튼 표시

#### 엣지케이스
- 다이얼로그에서 취소 선택: 구독 유지
- 다이얼로그 외부 클릭: 구독 유지
- 다음 결제일 당일 취소: 당일까지 혜택 유지
- 이미 취소 예약된 구독: 이미 취소 예약됨 메시지
- 네트워크 에러: 에러 메시지, 재시도 버튼
- 데이터베이스 업데이트 실패: 에러 메시지, 재시도 안내

---

### 6.4 Pro 구독 재개 플로우

#### 입력
- 구독 재개 버튼 클릭

#### 처리
1. 사용자가 구독 재개 버튼 클릭
2. 확인 다이얼로그 표시:
   - 제목: "구독을 재개하시겠습니까?"
   - 메시지: "다음 결제일(YYYY-MM-DD)에 자동 결제가 진행됩니다."
   - 버튼: "취소", "확인"
3. 사용자가 취소 선택: 다이얼로그 닫힘, 취소 예약 유지
4. 사용자가 확인 선택:
5. 서버로 재개 요청 전송
6. 서버에서 Supabase 업데이트:
   - subscriptions.status → 'active'
   - users.subscription_status → 'pro'
7. 성공 응답 반환
8. 구독 관리 페이지 리로드
9. 업데이트된 구독 정보 표시

#### 출력
- 재개 확인 다이얼로그 표시
- 재개 처리 중 로딩 표시
- 재개 완료 토스트 메시지
- 구독 관리 페이지 업데이트
- 구독 상태: Pro (활성)
- 다음 결제일 자동 결제 안내
- 구독 취소 버튼 표시

#### 엣지케이스
- 다이얼로그에서 취소 선택: 취소 예약 유지
- 다음 결제일 이후 재개 시도: 이미 해지된 구독, 신규 구독 필요 안내
- 빌링키 만료/삭제된 경우: 재개 불가, 신규 구독 필요 안내
- 네트워크 에러: 에러 메시지, 재시도 버튼
- 데이터베이스 업데이트 실패: 에러 메시지, 재시도 안내

---

### 6.5 정기 결제 자동 실행 (Cron Job)

#### 입력
- Supabase Cron Job 실행 (매일 오전 2시)

#### 처리
1. Cron Job이 오전 2시에 실행
2. Supabase에서 활성 구독 조회:
   - WHERE status = 'active'
   - AND next_billing_date = 오늘
3. 각 구독에 대해 순회:

**결제 시도:**
4. 토스페이먼츠 자동결제 승인 API 호출:
   - 빌링키 사용
   - 금액: 9,900원
   - 주문 ID 생성 (user_id + timestamp)

**결제 성공 시:**
5. payments 테이블에 INSERT:
   - user_id, subscription_id, payment_key, order_id
   - amount: 9900, status: 'done', paid_at: 현재
6. Supabase 업데이트:
   - users.test_count → 10 (재설정)
   - subscriptions.next_billing_date → 현재 + 30일
   - subscriptions.last_billing_date → 현재

**결제 실패 시:**
7. Supabase 업데이트:
   - subscriptions.status → 'payment_failed'
   - users.subscription_status → 'payment_failed'
8. 이메일 알림 발송:
   - 제목: "결제 실패 안내"
   - 내용: 결제 실패 사유, 재시도 안내
9. 3일 후 재시도 스케줄링

#### 출력
- 결제 성공: 사용자에게 영향 없음, 자동으로 검사 횟수 충전
- 결제 실패: 이메일 알림 발송, 구독 상태 변경

#### 엣지케이스
- 카드 한도 초과: 결제 실패, 재시도 안내
- 카드 만료: 결제 실패, 카드 정보 업데이트 요청
- 카드 분실/도난 정지: 결제 실패, 카드 변경 안내
- 3일 후 재시도 실패: 구독 자동 해지, 빌링키 삭제
- 동시 다중 결제 방지: 트랜잭션으로 중복 방지
- Cron Job 실행 실패: 다음 실행 시 누락된 결제 처리
- 토스페이먼츠 API 장애: 재시도 큐에 추가

---

### 6.6 구독 자동 해지 (Cron Job)

#### 입력
- Supabase Cron Job 실행 (매일 오전 2시)

#### 처리
1. Cron Job이 오전 2시에 실행
2. Supabase에서 취소 예약 구독 조회:
   - WHERE status = 'cancelled'
   - AND next_billing_date < 오늘
3. 각 구독에 대해 순회:

**빌링키 삭제:**
4. 토스페이먼츠 빌링키 삭제 API 호출
5. 삭제 성공 시:
   - subscriptions.status → 'terminated'
   - subscriptions.billing_key_deleted_at → 현재
   - users.subscription_status → 'free'
   - users.test_count → 0
6. 삭제 실패 시:
   - 에러 로깅
   - 재시도 큐에 추가
   - 다음 Cron 실행 시 재시도

#### 출력
- 자동으로 무료 요금제로 전환
- 사용자 다음 로그인 시:
  - 사이드바에 무료 요금제 표시
  - 잔여 횟수: 0회
  - Pro 구독하기 버튼 표시

#### 엣지케이스
- 빌링키 삭제 API 실패: 재시도 큐에 추가
- 이미 삭제된 빌링키: 정상 처리, 구독 상태만 업데이트
- 사용자가 해지 당일 서비스 이용 중: 트랜잭션 완료 후 상태 변경
- 동시 다중 해지: 각각 독립적으로 처리
- Cron Job 실행 실패: 다음 실행 시 누락된 해지 처리

---

### 6.7 결제 실패 재시도 (Cron Job)

#### 입력
- 결제 실패 3일 후 Cron Job 실행

#### 처리
1. Cron Job 실행
2. Supabase에서 결제 실패 구독 조회:
   - WHERE status = 'payment_failed'
   - AND last_billing_date + 3일 = 오늘
3. 각 구독에 대해 재결제 시도
4. 토스페이먼츠 자동결제 승인 API 호출

**재결제 성공 시:**
5. payments 테이블에 INSERT
6. Supabase 업데이트:
   - subscriptions.status → 'active'
   - users.subscription_status → 'pro'
   - users.test_count → 10
   - subscriptions.next_billing_date → 현재 + 30일
7. 이메일 알림: "결제 완료 안내"

**재결제 실패 시:**
8. 구독 자동 해지:
   - 빌링키 삭제
   - subscriptions.status → 'terminated'
   - users.subscription_status → 'free'
   - users.test_count → 0
9. 이메일 알림: "구독 해지 안내"

#### 출력
- 재결제 성공: Pro 구독 유지, 검사 횟수 충전
- 재결제 실패: 무료 요금제로 전환

#### 엣지케이스
- 재시도 중 사용자가 카드 정보 변경: 새 빌링키로 결제 시도
- 재시도 중 사용자가 구독 취소: 재시도 중단, 즉시 해지
- API 장애로 재시도 불가: 다음 날 재시도

---

## 7. 예외 상황 및 에러 처리

### 7.1 인증 관련 에러

#### 7.1.1 세션 만료

**발생 시점:**
- 보호된 페이지 접근 중
- API 호출 중

**처리:**
1. 미들웨어가 세션 만료 감지
2. 현재 URL을 returnUrl로 저장
3. 작업 중인 데이터가 있으면 로컬 스토리지에 임시 저장
4. Clerk 로그인 페이지로 리다이렉트
5. 재로그인 후 returnUrl로 복귀
6. 임시 저장된 데이터 복구

**사용자 경험:**
- 로그인 페이지로 자동 이동
- 재로그인 후 원래 작업 위치로 복귀
- 입력 중이던 데이터 복구

---

#### 7.1.2 권한 없음

**발생 시점:**
- 다른 사용자의 분석 접근 시도

**처리:**
1. 서버 컴포넌트에서 user_id 불일치 감지
2. 404 페이지 렌더링
3. 또는 대시보드로 리다이렉트

**사용자 경험:**
- 404 페이지 표시
- 대시보드로 돌아가기 버튼

---

### 7.2 API 관련 에러

#### 7.2.1 Gemini API 실패

**발생 원인:**
- API 키 만료 또는 잘못됨
- 할당량 초과
- 서비스 장애
- 네트워크 에러

**처리:**
1. API 호출 시 try-catch 블록
2. 에러 코드 확인
3. 사용자에게 적절한 메시지 표시
4. 1회 재시도 시도
5. Pro 모델 실패 시 flash 모델로 폴백 (사용자에게 안내)
6. 재시도 실패 시 최종 에러 메시지
7. test_count 차감하지 않음 (트랜잭션 롤백)

**사용자 경험:**
- 에러 토스트 메시지
- 재시도 버튼 제공
- 또는 대시보드로 돌아가기

**에러 메시지 예시:**
- API 키 오류: "시스템 오류가 발생했습니다. 잠시 후 다시 시도해주세요."
- 할당량 초과: "일시적으로 서비스 이용이 불가능합니다. 잠시 후 다시 시도해주세요."
- 타임아웃: "요청 시간이 초과되었습니다. 다시 시도해주세요."
- Pro 모델 폴백: "고급 분석이 일시적으로 불가능하여 기본 분석으로 진행합니다."

---

#### 7.2.2 API 타임아웃

**발생 조건:**
- 60초 내 응답 없음

**처리:**
1. 서버 액션에서 타임아웃 설정
2. 60초 경과 시 요청 중단
3. 타임아웃 에러 throw
4. 클라이언트에서 에러 캐치
5. 타임아웃 메시지 표시
6. test_count 차감하지 않음

**사용자 경험:**
- 타임아웃 안내 메시지
- 재시도 버튼
- 대시보드로 돌아가기 버튼

---

#### 7.2.3 토스페이먼츠 API 에러

**발생 원인:**
- 카드 정보 오류
- 한도 초과
- 본인인증 실패
- API 장애

**처리:**
1. 토스페이먼츠 에러 코드 확인
2. 사용자 친화적 메시지로 변환
3. 재시도 가능 여부 판단
4. 적절한 액션 제공

**에러 메시지 예시:**
- 카드 정보 오류: "카드 정보가 올바르지 않습니다. 다시 확인해주세요."
- 한도 초과: "카드 한도가 초과되었습니다. 다른 카드를 사용해주세요."
- 본인인증 실패: "본인인증에 실패했습니다. 다시 시도해주세요."

---

### 7.3 데이터베이스 관련 에러

#### 7.3.1 연결 실패

**발생 원인:**
- 네트워크 문제
- Supabase 서비스 장애
- 잘못된 연결 설정

**처리:**
1. 쿼리 실행 시 try-catch
2. 연결 에러 감지
3. 재시도 로직 (최대 3회)
4. 실패 시 에러 메시지

**사용자 경험:**
- 스켈레톤 로딩 (시도 중)
- 에러 메시지 및 재시도 버튼
- "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요."

---

#### 7.3.2 데이터 저장 실패

**발생 원인:**
- 제약 조건 위반
- 네트워크 에러
- 권한 문제

**처리:**
1. INSERT 실행 시 try-catch
2. 에러 코드 확인
3. 트랜잭션 롤백
4. 적절한 에러 메시지 생성
5. 사용자에게 전달

**사용자 경험:**
- 에러 토스트 메시지
- 재시도 버튼 또는 대시보드로 돌아가기
- test_count는 차감되지 않음

---

### 7.4 클라이언트 측 에러

#### 7.4.1 폼 검증 실패

**발생 조건:**
- 필수 항목 미입력
- 잘못된 형식
- 범위 초과

**처리:**
1. 각 필드별 실시간 검증
2. 에러 상태 업데이트
3. 에러 메시지 렌더링
4. 제출 버튼 비활성화 유지

**사용자 경험:**
- 필드 아래 에러 메시지 표시
- 필드 테두리 빨간색
- 제출 버튼 비활성화

**에러 메시지 예시:**
- 성함 미입력: "성함을 입력해주세요"
- 생년월일 형식 오류: "올바른 날짜를 입력해주세요 (YYYY-MM-DD)"
- 미래 날짜: "생년월일은 오늘 이전이어야 합니다"
- 성별 미선택: "성별을 선택해주세요"

---

#### 7.4.2 네트워크 에러

**발생 조건:**
- 인터넷 연결 끊김
- 서버 응답 없음

**처리:**
1. API 호출 시 네트워크 에러 캐치
2. 연결 상태 확인
3. 적절한 메시지 표시
4. 재시도 버튼 제공

**사용자 경험:**
- "네트워크 연결을 확인해주세요"
- 재시도 버튼
- 오프라인 표시

---

### 7.5 결제 관련 에러

#### 7.5.1 결제창 로드 실패

**발생 원인:**
- 토스페이먼츠 SDK 로드 실패
- 네트워크 에러

**처리:**
1. SDK 로드 시도
2. 실패 감지
3. 재시도 안내

**사용자 경험:**
- "결제 시스템 로딩 중 오류가 발생했습니다"
- 페이지 새로고침 버튼

---

#### 7.5.2 빌링키 발급 실패

**발생 원인:**
- 카드 정보 오류
- 본인인증 실패
- API 장애

**처리:**
1. 빌링키 발급 API 호출 실패 감지
2. 에러 코드 확인
3. 사용자 친화적 메시지 표시
4. 재시도 유도

**사용자 경험:**
- "카드 등록에 실패했습니다"
- 상세 오류 내용
- 재시도 버튼

---

#### 7.5.3 첫 결제 실패

**발생 원인:**
- 카드 한도 초과
- 결제 승인 거부

**처리:**
1. 첫 결제 API 호출 실패 감지
2. 발급된 빌링키 삭제
3. subscriptions 레코드 삭제
4. 에러 메시지 표시

**사용자 경험:**
- "결제에 실패했습니다"
- 오류 원인
- 다른 카드로 다시 시도 안내

---

### 7.6 Webhook 관련 에러

#### 7.6.1 Webhook 전송 실패

**발생 원인:**
- 배포 환경 엔드포인트 접근 불가
- 서버 오류

**처리:**
1. Clerk가 자동 재시도 (exponential backoff)
2. 서버 측 로그 기록
3. 최대 재시도 후 실패 시 수동 동기화

**사용자 경험:**
- 사용자는 인지하지 못함
- Clerk 세션은 정상 작동
- Supabase 데이터는 백그라운드에서 동기화

---

#### 7.6.2 Webhook 검증 실패

**발생 원인:**
- 잘못된 서명
- 만료된 요청
- 악의적인 요청

**처리:**
1. 서버에서 Clerk 서명 검증
2. 검증 실패 시 요청 거부
3. 에러 로그 기록
4. 400 응답 반환

**사용자 경험:**
- 사용자는 인지하지 못함
- 보안 강화

---

### 7.7 페이지별 에러 처리 요약

#### 홈페이지
- 네트워크 에러: 정적 컨텐츠 표시 유지
- 로그인 버튼 클릭 실패: 에러 메시지 및 재시도

#### 대시보드
- 데이터 로딩 실패: 에러 메시지, 재시도 버튼
- 빈 상태: 첫 검사 시작하기 버튼
- 세션 만료: 로그인 페이지로 리다이렉트
- 구독 정보 로딩 실패: 기본 정보만 표시, 배경에서 재시도

#### 새 검사하기
- 폼 검증 실패: 필드별 에러 메시지
- API 호출 실패: 에러 토스트, 재시도 버튼, test_count 차감 안함
- 타임아웃: 타임아웃 메시지, 재시도 안내, test_count 차감 안함
- 세션 만료: 입력 데이터 임시 저장, 로그인 페이지로
- test_count 부족: 구독 유도 다이얼로그
- Pro 모델 실패: flash 모델 폴백, 사용자에게 안내

#### 사주분석 상세
- 존재하지 않는 ID: 404 페이지
- 권한 없음: 404 또는 대시보드로 리다이렉트
- 데이터 로딩 실패: 에러 메시지, 대시보드로 돌아가기
- 마크다운 렌더링 실패: 원본 텍스트 표시

#### 구독 관리
- 데이터 로딩 실패: 에러 메시지, 재시도 버튼
- 결제창 로드 실패: 페이지 새로고침 안내
- 결제 실패: 상세 오류 메시지, 재시도 또는 다른 카드 안내
- 구독 취소/재개 실패: 에러 메시지, 재시도 버튼

---

## 8. 성능 최적화 관련 플로우

### 8.1 페이지 로딩 최적화

**처리:**
1. Next.js App Router 서버 컴포넌트 활용
2. 정적 컨텐츠 사전 렌더링
3. 동적 데이터만 클라이언트 측 페칭
4. 이미지 최적화 (Next.js Image)
5. 코드 스플리팅 자동 적용
6. Vercel Edge Network 캐싱

**사용자 경험:**
- 빠른 초기 페이지 로드
- 부드러운 페이지 전환

---

### 8.2 데이터 페칭 최적화

**처리:**
1. 서버 컴포넌트에서 데이터 페칭
2. 필요한 컬럼만 SELECT
3. 인덱스 활용 쿼리 최적화
4. 페이지네이션으로 대량 데이터 방지
5. React Suspense 활용 스트리밍

**사용자 경험:**
- 빠른 데이터 로딩
- 스켈레톤 로딩으로 UX 개선

---

### 8.3 AI 분석 대기 UX

**처리:**
1. 검사 시작 클릭 시 즉시 로딩 표시
2. 로딩 다이얼로그 렌더링
3. 실시간 스트리밍으로 진행 중인 결과 표시
4. 예상 대기 시간 안내 (무료: 10-20초, Pro: 20-40초)
5. 백그라운드에서 API 호출
6. 완료 시 alert 표시 후 자동 페이지 전환

**사용자 경험:**
- 명확한 로딩 상태 표시
- 실시간으로 분석 결과 확인
- 예상 시간 안내로 불안감 감소
- 자동 전환으로 편의성 향상

---

## 9. 접근성 관련 플로우

### 9.1 키보드 네비게이션

**지원 기능:**
- Tab 키로 모든 인터랙티브 요소 접근
- Enter/Space 키로 버튼 활성화
- Esc 키로 모달/다이얼로그 닫기
- 포커스 표시 명확화

---

### 9.2 스크린 리더 지원

**구현 사항:**
- 의미 있는 ARIA 라벨
- role 속성 명시
- 에러 메시지에 aria-live 적용
- 로딩 상태 aria-busy 표시

---

## 10. 모바일 대응 플로우

### 10.1 반응형 레이아웃

**처리:**
- 320px 이상 모든 화면 크기 지원
- 터치 친화적 버튼 크기 (최소 44x44px)
- 스와이프 제스처 지원 (카드 네비게이션)
- 모바일 최적화 폼 입력
- 사이드바는 모바일에서 하단 네비게이션으로 전환

**사용자 경험:**
- 모든 디바이스에서 일관된 경험
- 터치 조작 편의성

---

## 11. 보안 관련 플로우

### 11.1 XSS 방지

**처리:**
- React 자동 이스케이프 활용
- 마크다운 렌더러에 sanitize 적용
- 사용자 입력 검증 및 필터링

---

### 11.2 CSRF 방지

**처리:**
- Clerk JWT 기반 인증
- 서버 액션에서 토큰 검증
- SameSite 쿠키 설정

---

### 11.3 데이터 접근 제어

**처리:**
- RLS (Row Level Security) 적용
- 서버 컴포넌트에서 user_id 검증
- 본인 데이터만 접근 허용

---

### 11.4 결제 정보 보안

**처리:**
- 빌링키는 토스페이먼츠가 관리
- 카드 정보는 마지막 4자리만 저장
- customerKey는 UUID 사용 (유추 불가)
- HTTPS 통신 강제

---

## 문서 이력

| 버전 | 날짜 | 작성자 | 변경 내역 |
|------|------|--------|----------|
| 1.0 | 2025-10-27 | Claude Code | 초안 작성 |
| 2.0 | 2025-10-28 | Claude Code | 구독 관리 플로우 추가, 전체 플로우 개선 |
