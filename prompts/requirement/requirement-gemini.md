# 요구사항 정의서 (Requirement Document)

## 1. 개요
본 문서는 구독형 사주 분석 서비스 구현 프로젝트의 목표, 주요 기능 및 기술 스택, 평가 기준을 정의한다.

## 2. 목표 시스템
사용자 인증(Clerk 로그인)을 기반으로 사주 분석 기능을 제공하며, 토스페이먼츠를 통한 구독 결제 시스템을 연동하여 유료 사용자에게 고성능 분석 및 추가 기능을 제공한다.

## 3. 기술 스택
| 구분                | 기술 스택                        | 목적                                                         |
| :------------------ | :------------------------------- | :----------------------------------------------------------- |
| 프론트엔드/백엔드   | **Next.js (App Router)**         | 풀스택 웹 애플리케이션 프레임워크                            |
| 인증                | **Clerk**                        | 사용자 인증, 세션 관리, 로그인 연동, Webhook 제공      |
| 데이터베이스/백엔드 | **Supabase**                     | PostgreSQL DB, Auth (Clerk과 연동), Realtime, Storage, **Cron Jobs** 활용 |
| 결제                | **토스페이먼츠 (Toss Payments)** | 정기 결제 (구독) 기능 구현 (빌링키 발급 및 결제)             |
| AI 분석             | **Google Gemini API**            | 사주 분석 코어 로직 구현 (gemini-2.5-flash 및 gemini-2.5-pro 사용) |

## 4. 기능 요구사항

### 4.1. 사용자 인증 (Clerk 연동)
1.  **Clerk 로그인**을 포함한 인증 관련 페이지는 모두 **Clerk SDK 기본 컴포넌트**를 사용하여 구현한다.
2.  **Clerk Webhook**을 사용하여 사용자 생성/업데이트/삭제 이벤트 발생 시 Supabase DB에 사용자 정보를 동기화한다.

### 4.2. 페이지 접근성
1.  **홈 (랜딩페이지)**: 인증 상태와 무관하게 접근 가능하다.
2.  **대시보드, 새 분석하기, 분석 상세보기, 구독 관리, 구독 정책**: **인증 상태(로그인)로만 접근 가능**하다. (Clerk 미들웨어/컴포넌트를 활용하여 보호)

### 4.3. 사주 분석 기능 (Gemini API 연동)
1.  **무료 가입 유저**:
    * **최초 3회**의 분석 테스트 횟수를 제공한다.
    * Gemini API 호출 시 **`gemini-2.5-flash`** 모델을 사용한다.
2.  **Pro 요금제 구독 고객**:
    * **월 10회**의 분석 테스트 횟수를 제공한다.
    * Gemini API 호출 시 **`gemini-2.5-pro`** 모델을 사용한다.
3.  분석 요청 시, 사용자의 잔여 테스트 횟수를 차감한다. (Supabase DB 관리)
4.  분석 프롬프트는 제공된 예시를 기반으로 구현한다.

### 4.4. 구독 결제 및 관리 (토스페이먼츠 연동)

#### 4.4.1. 구독 결제
1.  '구독 정책' 페이지에서 **Pro 요금제 구독 결제 (정기 결제)**를 진행할 수 있다.
2.  토스페이먼츠 SDK를 사용하여 **빌링키(Billing Key)**를 발급받는다.
3.  빌링키 발급 성공 시, 해당 정보를 Supabase DB에 저장하고 사용자 구독 상태를 'Active'로 변경한다.
4.  **최초 결제**는 즉시 실행된다.

#### 4.4.2. 자동 정기 결제 (Supabase Cron 및 Next.js API)
1.  **Supabase Cron Jobs**를 설정하여 **매일 02:00 (KST)**에 Next.js의 특정 API 경로를 호출한다.
2.  Next.js API는 호출의 유효성을 검증한다.
3.  Next.js API는 Supabase DB에서 **오늘이 결제일인 유효한 구독 건**들(상태: Active, Cancellation Pending)을 탐색한다.
4.  탐색된 각 건에 대해 다음 로직을 적용한다.

    **A. 구독 해지 예정 건 처리 (Cancellation Pending)**
    * 해당 건이 해지 예정 상태이고 오늘이 결제일인 경우:
        * 구독 상태를 **'Expired/Cancelled'**로 변경한다.
        * **토스페이먼츠 API를 통해 빌링키를 즉시 삭제**한다.
        * 사용자 혜택(Pro 모델, 테스트 횟수)을 회수한다.
    
    **B. 활성 구독 건 처리 (Active)**
    * 해당 건이 활성 상태이고 오늘이 결제일인 경우:
        * **토스페이먼츠 정기 결제 API**를 호출하여 결제를 시도한다.
        * **결제 성공 시**:
            * Supabase DB에 `users` 테이블의 `test_count`를 **+10회** 추가한다.
            * `subscriptions` 테이블의 `next_payment_date`를 **1개월 연장**한다.
        * **결제 실패 시**:
            * 해당 구독 건을 **즉시 해지** 처리한다.
            * 구독 상태를 **'Expired/Failed'**로 변경한다.
            * **토스페이먼츠 API를 통해 빌링키를 즉시 삭제**한다.
            * 사용자 혜택을 회수한다.

5.  재구독을 위해서는 토스페이먼츠 SDK를 통한 빌링키 재발급이 필수이다.

#### 4.4.3. 구독 취소 및 해지 관리
1.  사용자는 '구독 관리' 페이지에서 **구독 해지**를 신청할 수 있다.
2.  해지 신청 시, 구독 상태는 **'Cancellation Pending'**으로 변경된다.
3.  'Cancellation Pending' 상태에서는 **다음 결제일**까지 **구독 상태가 유지**되며, Pro 요금제 혜택을 계속 이용할 수 있다.
4.  'Cancellation Pending' 상태에서 사용자는 **취소 상태를 철회**할 수 있으며, 이 경우 구독 상태는 다시 'Active'로 변경된다.

## 5. 평가 Point (Checklist)
* [ ] Clerk SDK 연동이 오류 없이 완료되었는가 (인증, Webhook 포함)
* [ ] Supabase 연동이 오류 없이 완료되었는가 (DB, Cron Jobs 포함)
* [ ] 토스페이먼츠 SDK 및 API 연동이 오류 없이 완료되었는가 (빌링키 발급, 정기 결제, 빌링키 삭제)
* [ ] Gemini API 연동이 오류 없이 완료되었는가 (flash/pro 모델 분기 처리)
* [ ] 깔끔하고 모호하지 않은 본 `requirement.md` 문서가 작성되었는가.
* [ ] (가산점) 사용한 프롬프트/Agent 로직을 잘 저장했는가.